---
title: "Mens Prediction"
output: html_document
date: "2024-03-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr) # for data cleaning
library(xgboost) #For modelling
setwd("/Users/jakesak/Documents/MM Mania Kaggle/Code")
Seeds <- read.csv(file.path("../Data", "2024_tourney_seeds.csv" ))
MensSeeds <- Seeds %>% 
  filter(Tournament == "M")
Sub <- read.csv(file.path("../Data", "sample_submission.csv" ))
Slots <- read.csv(file.path("../Data", "MNCAATourneySeedRoundSlots.csv" ))
Predictors <- read.csv(file.path("../Data", "predictors.csv" ))
MTeams <- read.csv(file.path("../Data", "MTeams.csv" ))
MTeams <- MTeams %>% select(TeamID, TeamName)
```


```{r}
#General
Predictors_2024 <- Predictors %>% filter(Season == 2024)
predictors <- c("T1Win_pct", "T1Pts_for", "T1Pts_against","T1Pts_diff", 
                "T1rawSOS", "T1ELOSOS", "T1FgPct", "T1ThreePtPct", "T1ThreePtShots",
                "T1FtPct", "T1FtA", "T1OppFgPct", "T1OppThreePtPct", "T1OppThreePtShots", 
                "T1OppFtA", "T1Wins", "T1Losses", "T1Reb", "T1OReb", "T1ORebRat", "T1BlkStl",
                "T1TO", "T1TurnRat", "T1AsstRat", "T1OppReb", "T1OppORebRat", 
                "T1ELO", "T1Quad1Rec", "T1Quad1Games", "T2Win_pct", "T2Pts_for", 
                "T2Pts_against", "T2Pts_diff","T2rawSOS", "T2ELOSOS", 
                "T2FgPct", "T2ThreePtPct", "T2ThreePtShots", "T2FtPct", 
                "T2FtA", "T2OppFgPct", "T2OppThreePtPct", "T2OppThreePtShots", 
                "T2OppFtA", "T2Wins", "T2Losses", "T2Reb", "T2OReb", "T2ORebRat", "T2BlkStl", 
                "T2TO", "T2TurnRat", "T2AsstRat", "T2OppReb", "T2OppORebRat", 
                "T2ELO", "T2Quad1Rec", "T2Quad1Games", "ELO_diff", "T1Rank", "T2Rank",
                "Win_pct_dif", "PTS_for", "PTS_against", 
                "ThreePtShots_diff", "Reb_diff", "ORebRate_diff", "OppORebRate_diff", 
                "Turn_diff","ELOSOS_diff", "Rank_diff")
#Unused: "T1OppBlkStl", "T1OppAsstRat", "T2OppBlkStl", "T2OppAsstRat", 
#"T1LBlowouts", "T2LBlowouts", "T1LClose", "T2LClose", "Seed_diff", "rawSOS_diff"

#Seeding info
initial_slots <- c(
  'R1W1', 'R1W2', 'R1W3', 'R1W4', 'R1W5', 'R1W6', 'R1W7', 'R1W8',
  'R1X1', 'R1X2', 'R1X3', 'R1X4', 'R1X5', 'R1X6', 'R1X7', 'R1X8',
  'R1Y1', 'R1Y2', 'R1Y3', 'R1Y4', 'R1Y5', 'R1Y6', 'R1Y7', 'R1Y8',
  'R1Z1', 'R1Z2', 'R1Z3', 'R1Z4', 'R1Z5', 'R1Z6', 'R1Z7', 'R1Z8'
)

initial_matchups <- list(
  'R1W1' = c("01", "16"),
  'R1W2' = c("02", "15"),
  'R1W3' = c("03", "14"),
  'R1W4' = c("04", "13"),
  'R1W5' = c("05", "12"),
  'R1W6' = c("06", "11"),
  'R1W7' = c("07", "10"),
  'R1W8' = c("08", "09"),
  'R1X1' = c("01", "16"),
  'R1X2' = c("02", "15"),
  'R1X3' = c("03", "14"),
  'R1X4' = c("04", "13"),
  'R1X5' = c("05", "12"),
  'R1X6' = c("06", "11"),
  'R1X7' = c("07", "10"),
  'R1X8' = c("08", "09"),
  'R1Y1' = c("01", "16"),
  'R1Y2' = c("02", "15"),
  'R1Y3' = c("03", "14"),
  'R1Y4' = c("04", "13"),
  'R1Y5' = c("05", "12"),
  'R1Y6' = c("06", "11"),
  'R1Y7' = c("07", "10"),
  'R1Y8' = c("08", "09"),
  'R1Z1' = c("01", "16"),
  'R1Z2' = c("02", "15"),
  'R1Z3' = c("03", "14"),
  'R1Z4' = c("04", "13"),
  'R1Z5' = c("05", "12"),
  'R1Z6' = c("06", "11"),
  'R1Z7' = c("07", "10"),
  'R1Z8' = c("08", "09")
)


round2_map <- list(
  'R1W1' = 'R2W1', 'R1W8' = 'R2W1',
  'R1W2' = 'R2W2', 'R1W7' = 'R2W2',
  'R1W3' = 'R2W3', 'R1W6' = 'R2W3',
  'R1W4' = 'R2W4', 'R1W5' = 'R2W4',
  'R1X1' = 'R2X1', 'R1X8' = 'R2X1',
  'R1X2' = 'R2X2', 'R1X7' = 'R2X2',
  'R1X3' = 'R2X3', 'R1X6' = 'R2X3',
  'R1X4' = 'R2X4', 'R1X5' = 'R2X4',
  'R1Y1' = 'R2Y1', 'R1Y8' = 'R2Y1',
  'R1Y2' = 'R2Y2', 'R1Y7' = 'R2Y2',
  'R1Y3' = 'R2Y3', 'R1Y6' = 'R2Y3',
  'R1Y4' = 'R2Y4', 'R1Y5' = 'R2Y4',
  'R1Z1' = 'R2Z1', 'R1Z8' = 'R2Z1',
  'R1Z2' = 'R2Z2', 'R1Z7' = 'R2Z2',
  'R1Z3' = 'R2Z3', 'R1Z6' = 'R2Z3',
  'R1Z4' = 'R2Z4', 'R1Z5' = 'R2Z4'
)

round3_map <- list(
  'R2W1' = 'R3W1', 'R2W4' = 'R3W1',
  'R2W2' = 'R3W2', 'R2W3' = 'R3W2',
  'R2X1' = 'R3X1', 'R2X4' = 'R3X1',
  'R2X2' = 'R3X2', 'R2X3' = 'R3X2',
  'R2Y1' = 'R3Y1', 'R2Y4' = 'R3Y1',
  'R2Y2' = 'R3Y2', 'R2Y3' = 'R3Y2',
  'R2Z1' = 'R3Z1', 'R2Z4' = 'R3Z1',
  'R2Z2' = 'R3Z2', 'R2Z3' = 'R3Z2'
)

round4_map <- list(
  'R3W1' = 'R4W1', 'R3W2' = 'R4W1',
  'R3X1' = 'R4X1', 'R3X2' = 'R4X1',
  'R3Y1' = 'R4Y1', 'R3Y2' = 'R4Y1',
  'R3Z1' = 'R4Z1', 'R3Z2' = 'R4Z1'
)

round5_map <- list(
  'R4W1' = 'R5WX', 'R4X1' = 'R5WX',
  'R4Y1' = 'R5YZ', 'R4Z1' = 'R5YZ'
)

round6_map <- list(
  'R5WX' = 'R6CH',
  'R5YZ' = 'R6CH'
)
```


```{r}
#Round 1 Predictions
Rd1Df <- data.frame(Slot = character(), Team1 = character(), Team2 = character(), 
                    SeedNum_T1 = numeric(), SeedNum_T2 = numeric())
for (key in names(initial_matchups)) {
  slot <- substr(key, 3, 3)
  teams <- initial_matchups[[key]]
  SeedNum_T1 <- as.numeric(teams[1])
  SeedNum_T2 <- as.numeric(teams[2])
  team1 <- paste0(slot, teams[1])
  team2 <- paste0(slot, teams[2])
  row_df <- data.frame(Slot = key, Team1 = team1, Team2 = team2, 
                       SeedNum_T1 = SeedNum_T1,  SeedNum_T2 =  SeedNum_T2)
  Rd1Df <- rbind(Rd1Df, row_df)
}
Rd1Df$Tournament = "M"

Rd1_team1 <- Rd1Df %>% 
  left_join(MensSeeds, by = c("Tournament", "Team1" = "Seed")) %>% 
  rename(Team1ID = TeamID)
Rd1_team2 <- Rd1Df %>% 
  left_join(MensSeeds, by = c("Tournament", "Team2" = "Seed")) %>% 
  rename(Team2ID = TeamID)

Rd1_pred <- merge(Rd1_team1, Rd1_team2, 
                  by = c("Tournament", "Slot", "Team1", "Team2",  
                         "SeedNum_T1",  "SeedNum_T2"), all = TRUE)
Rd1_data <- Rd1_pred %>% 
  left_join(Predictors_2024, by = c("Team1ID" = "TeamID")) %>% 
  rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, 
         T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, 
         T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, 
         T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,
         T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, 
         T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, 
         T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, T1BlkStl = BlkStl, 
         T1TO = TO, T1TurnRat = TurnRat, T1AsstRat = AsstRat, T1OppReb = OppReb, 
         T1OppORebRat = OppORebRat, 
         T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,
         T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)
Rd1_data <- Rd1_data %>% 
  left_join(Predictors_2024, by = c("Team2ID" = "TeamID")) %>% 
  rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against, 
         T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, 
         T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, 
         T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,
         T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, 
         T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, 
         T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, T2BlkStl = BlkStl, 
         T2TO = TO, T2TurnRat = TurnRat, T2AsstRat = AsstRat, T2OppReb = OppReb, 
         T2OppORebRat = OppORebRat, 
         T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,
         T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)
Rd1_data$ELO_diff <- Rd1_data$T1ELO - Rd1_data$T2ELO
Rd1_data$Seed_diff <- Rd1_data$SeedNum_T1 - Rd1_data$SeedNum_T2
Rd1_data$Win_pct_dif <- Rd1_data$T1Win_pct - Rd1_data$T2Win_pct
Rd1_data$PTS_for <- Rd1_data$T1Pts_for - Rd1_data$T2Pts_for
Rd1_data$PTS_against <- Rd1_data$T1Pts_against - Rd1_data$T2Pts_against
Rd1_data$ThreePtShots_diff <- Rd1_data$T1ThreePtShots - Rd1_data$T2ThreePtShots
Rd1_data$Reb_diff <- Rd1_data$T1Reb - Rd1_data$T2Reb
Rd1_data$ORebRate_diff <- Rd1_data$T1ORebRat - Rd1_data$T2ORebRat
Rd1_data$OppORebRate_diff <- Rd1_data$T1OppORebRat - Rd1_data$T2OppORebRat
Rd1_data$Turn_diff = Rd1_data$T1TO - Rd1_data$T2TO
Rd1_data$rawSOS_diff <- Rd1_data$T1rawSOS - Rd1_data$T2rawSOS
Rd1_data$ELOSOS_diff <- Rd1_data$T1ELOSOS - Rd1_data$T2ELOSOS
Rd1_data$Rank_diff <- Rd1_data$T1Rank - Rd1_data$T2Rank
rd_1_dmatrix <- xgb.DMatrix(data = as.matrix(Rd1_data[, predictors]))
predictions <- predict(final_model, newdata = rd_1_dmatrix)
Rd1_pred$Team <- ifelse(predictions >= 0.5, Rd1_pred$Team1ID, Rd1_pred$Team2ID)
Rd1_pred$Win <- ifelse(Rd1_pred$Team == Rd1_pred$Team1ID, Rd1_pred$Team1, Rd1_pred$Team2)
Rd1_pred$Seed <- ifelse(Rd1_pred$Team == Rd1_pred$Team1ID, 
                        Rd1_pred$SeedNum_T1, Rd1_pred$SeedNum_T2)
```


```{r}
#Define round by round function
Rd_by_rd <- function(rd1, map, Predictors_2024, features) {
  unique_destinations <- unique(unlist(map))
  new_pred <- data.frame(Tournament = "M",
                         Slot = unique_destinations,
                         Team1 = character(length(unique_destinations)),
                         Team2 = character(length(unique_destinations)),
                         Team1ID = integer(length(unique_destinations)),
                         Team2ID = integer(length(unique_destinations)),
                         SeedNum_T1 = numeric(length(unique_destinations)),
                         SeedNum_T2 = numeric(length(unique_destinations)))
  for (i in 1:nrow(rd1)) {
    Slot <- rd1$Slot[i]
    Dest <- map[[Slot]]
    row_index <- which(new_pred$Slot == Dest)
    if (nchar(as.character(new_pred[row_index, "Team1"])) != 3) {
      # Data corresponds to Team1
      new_pred[row_index, "Team1"] <- rd1$Win[i]
      new_pred[row_index, "Team1ID"] <- rd1$Team[i]
      new_pred[row_index, "SeedNum_T1"] <- rd1$Seed[i]
    } else {
      # Data corresponds to Team2
      new_pred[row_index, "Team2"] <- rd1$Win[i]
      new_pred[row_index, "Team2ID"] <- rd1$Team[i]
      new_pred[row_index, "SeedNum_T2"] <- rd1$Seed[i]
    }
  }
  #Add features
  Rd1_data <- new_pred %>% 
    left_join(Predictors_2024, by = c("Team1ID" = "TeamID")) %>% 
    rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, 
           T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, 
           T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, 
           T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,
           T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, 
           T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, 
           T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, T1BlkStl = BlkStl, 
           T1TO = TO, T1TurnRat = TurnRat, T1AsstRat = AsstRat, T1OppReb = OppReb, T1OppORebRat = OppORebRat, 
           T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,
           T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)
  Rd1_data <- Rd1_data %>% 
    left_join(Predictors_2024, by = c("Team2ID" = "TeamID")) %>% 
    rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against,
           T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, 
           T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, 
           T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,
           T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, 
           T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, 
           T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, T2BlkStl = BlkStl, 
           T2TO = TO, T2TurnRat = TurnRat, T2AsstRat = AsstRat, T2OppReb = OppReb, T2OppORebRat = OppORebRat, 
           T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,
           T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)
  Rd1_data$ELO_diff <- Rd1_data$T1ELO - Rd1_data$T2ELO
  Rd1_data$Seed_diff <- Rd1_data$SeedNum_T1 - Rd1_data$SeedNum_T2
  Rd1_data$Win_pct_dif <- Rd1_data$T1Win_pct - Rd1_data$T2Win_pct
  Rd1_data$PTS_for <- Rd1_data$T1Pts_for - Rd1_data$T2Pts_for
  Rd1_data$PTS_against <- Rd1_data$T1Pts_against - Rd1_data$T2Pts_against
  Rd1_data$ThreePtShots_diff <- Rd1_data$T1ThreePtShots - Rd1_data$T2ThreePtShots
  Rd1_data$Reb_diff <- Rd1_data$T1Reb - Rd1_data$T2Reb
  Rd1_data$ORebRate_diff <- Rd1_data$T1ORebRat - Rd1_data$T2ORebRat
  Rd1_data$OppORebRate_diff <- Rd1_data$T1OppORebRat - Rd1_data$T2OppORebRat
  Rd1_data$Turn_diff = Rd1_data$T1TO - Rd1_data$T2TO
  Rd1_data$rawSOS_diff <- Rd1_data$T1rawSOS - Rd1_data$T2rawSOS
  Rd1_data$ELOSOS_diff <- Rd1_data$T1ELOSOS - Rd1_data$T2ELOSOS
  Rd1_data$Rank_diff <- Rd1_data$T1Rank - Rd1_data$T2Rank
  #Predictions
  rd_1_dmatrix <- xgb.DMatrix(data = as.matrix(Rd1_data[, features]))
  predictions <- predict(final_model, newdata = rd_1_dmatrix)
  new_pred$Team <- ifelse(predictions >= 0.5, new_pred$Team1ID, new_pred$Team2ID)
  new_pred$Win <- ifelse(new_pred$Team == new_pred$Team1ID, new_pred$Team1, new_pred$Team2)
  new_pred$Seed <- ifelse(new_pred$Team == new_pred$Team1ID, 
                          new_pred$SeedNum_T1, new_pred$SeedNum_T2)
  return(new_pred)
}
```


```{r}
#Rest of rounds
Rd2_pred <- Rd_by_rd(Rd1_pred, round2_map, Predictors_2024, predictors)
Rd3_pred <- Rd_by_rd(Rd2_pred, round3_map, Predictors_2024, predictors)
Rd4_pred <- Rd_by_rd(Rd3_pred, round4_map, Predictors_2024, predictors)
Rd5_pred <- Rd_by_rd(Rd4_pred, round5_map, Predictors_2024, predictors)
Rd6_pred <- Rd_by_rd(Rd5_pred, round6_map, Predictors_2024, predictors)
```


```{r}
#Combine all data
Rd12_pred <- rbind(Rd1_pred, Rd2_pred)
Rd123_pred <- rbind(Rd12_pred, Rd3_pred)
Rd1234_pred <- rbind(Rd123_pred, Rd4_pred)
Rd12345_pred <- rbind(Rd1234_pred, Rd5_pred)
All_pred <- rbind(Rd12345_pred, Rd6_pred) 
All_pred <- All_pred %>% left_join(MTeams, by = c("Team" = "TeamID"))

Final_names <- All_pred %>%  
  mutate(Bracket = 1) %>% 
  select(Tournament, Bracket, Slot, Team = Win, TeamName)

Final <- All_pred %>%  
  mutate(Bracket = 1) %>% 
  select(Tournament, Bracket, Slot, Team = Win)
#Final$RowId <- seq_len(nrow(Final))
```


