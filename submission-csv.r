{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "0b7f4b07",
   "metadata": {
    "_execution_state": "idle",
    "_uuid": "051d70d956493feee0c6d64651c6a088724dca2a",
    "execution": {
     "iopub.execute_input": "2024-03-21T00:16:45.053913Z",
     "iopub.status.busy": "2024-03-21T00:16:45.051376Z",
     "iopub.status.idle": "2024-03-21T00:16:46.416947Z",
     "shell.execute_reply": "2024-03-21T00:16:46.415120Z"
    },
    "papermill": {
     "duration": 1.384526,
     "end_time": "2024-03-21T00:16:46.420270",
     "exception": false,
     "start_time": "2024-03-21T00:16:45.035744",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "── \u001b[1mAttaching core tidyverse packages\u001b[22m ──────────────────────── tidyverse 2.0.0 ──\n",
      "\u001b[32m✔\u001b[39m \u001b[34mdplyr    \u001b[39m 1.1.4     \u001b[32m✔\u001b[39m \u001b[34mreadr    \u001b[39m 2.1.4\n",
      "\u001b[32m✔\u001b[39m \u001b[34mforcats  \u001b[39m 1.0.0     \u001b[32m✔\u001b[39m \u001b[34mstringr  \u001b[39m 1.5.1\n",
      "\u001b[32m✔\u001b[39m \u001b[34mggplot2  \u001b[39m 3.4.4     \u001b[32m✔\u001b[39m \u001b[34mtibble   \u001b[39m 3.2.1\n",
      "\u001b[32m✔\u001b[39m \u001b[34mlubridate\u001b[39m 1.9.3     \u001b[32m✔\u001b[39m \u001b[34mtidyr    \u001b[39m 1.3.0\n",
      "\u001b[32m✔\u001b[39m \u001b[34mpurrr    \u001b[39m 1.0.2     \n",
      "── \u001b[1mConflicts\u001b[22m ────────────────────────────────────────── tidyverse_conflicts() ──\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mfilter()\u001b[39m masks \u001b[34mstats\u001b[39m::filter()\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mlag()\u001b[39m    masks \u001b[34mstats\u001b[39m::lag()\n",
      "\u001b[36mℹ\u001b[39m Use the conflicted package (\u001b[3m\u001b[34m<http://conflicted.r-lib.org/>\u001b[39m\u001b[23m) to force all conflicts to become errors\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "'march-machine-learning-mania-2024'"
      ],
      "text/latex": [
       "'march-machine-learning-mania-2024'"
      ],
      "text/markdown": [
       "'march-machine-learning-mania-2024'"
      ],
      "text/plain": [
       "[1] \"march-machine-learning-mania-2024\""
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# This R environment comes with many helpful analytics packages installed\n",
    "# It is defined by the kaggle/rstats Docker image: https://github.com/kaggle/docker-rstats\n",
    "# For example, here's a helpful package to load\n",
    "\n",
    "library(tidyverse) # metapackage of all tidyverse packages\n",
    "\n",
    "# Input data files are available in the read-only \"../input/\" directory\n",
    "# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n",
    "\n",
    "list.files(path = \"../input\")\n",
    "\n",
    "# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n",
    "# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a16caf1d",
   "metadata": {
    "papermill": {
     "duration": 0.012137,
     "end_time": "2024-03-21T00:16:46.444613",
     "exception": false,
     "start_time": "2024-03-21T00:16:46.432476",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# MENS DATA\n",
    "## Code to Make Men's ELO Rankings by Season\n",
    "Using an optimizing function, optimized the elo.run formula from elo database to optimize parameters K, location, score differential, and date"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "e0f8e2f7",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:16:46.504050Z",
     "iopub.status.busy": "2024-03-21T00:16:46.471693Z",
     "iopub.status.idle": "2024-03-21T00:26:08.445946Z",
     "shell.execute_reply": "2024-03-21T00:26:08.443766Z"
    },
    "papermill": {
     "duration": 561.992597,
     "end_time": "2024-03-21T00:26:08.449830",
     "exception": false,
     "start_time": "2024-03-21T00:16:46.457233",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n",
      "Attaching package: ‘limSolve’\n",
      "\n",
      "\n",
      "The following object is masked from ‘package:ggplot2’:\n",
      "\n",
      "    resolution\n",
      "\n",
      "\n",
      "Loading required package: gsubfn\n",
      "\n",
      "Loading required package: proto\n",
      "\n",
      "Warning message:\n",
      "“no DISPLAY variable so Tk is not available”\n",
      "Loading required package: RSQLite\n",
      "\n",
      "\n",
      "Attaching package: ‘RCurl’\n",
      "\n",
      "\n",
      "The following object is masked from ‘package:tidyr’:\n",
      "\n",
      "    complete\n",
      "\n",
      "\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<dl>\n",
       "\t<dt>$par</dt>\n",
       "\t\t<dd><style>\n",
       ".list-inline {list-style: none; margin:0; padding: 0}\n",
       ".list-inline>li {display: inline-block}\n",
       ".list-inline>li:not(:last-child)::after {content: \"\\00b7\"; padding: 0 .5ex}\n",
       "</style>\n",
       "<ol class=list-inline><li>0.206723057983939</li><li>-0.0184571841295454</li><li>3.38075908519519</li><li>0</li></ol>\n",
       "</dd>\n",
       "\t<dt>$value</dt>\n",
       "\t\t<dd>0.193358384270264</dd>\n",
       "\t<dt>$counts</dt>\n",
       "\t\t<dd><style>\n",
       ".dl-inline {width: auto; margin:0; padding: 0}\n",
       ".dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}\n",
       ".dl-inline>dt::after {content: \":\\0020\"; padding-right: .5ex}\n",
       ".dl-inline>dt:not(:first-of-type) {padding-left: .5ex}\n",
       "</style><dl class=dl-inline><dt>function</dt><dd>11</dd><dt>gradient</dt><dd>11</dd></dl>\n",
       "</dd>\n",
       "\t<dt>$convergence</dt>\n",
       "\t\t<dd>0</dd>\n",
       "\t<dt>$message</dt>\n",
       "\t\t<dd>'CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH'</dd>\n",
       "</dl>\n"
      ],
      "text/latex": [
       "\\begin{description}\n",
       "\\item[\\$par] \\begin{enumerate*}\n",
       "\\item 0.206723057983939\n",
       "\\item -0.0184571841295454\n",
       "\\item 3.38075908519519\n",
       "\\item 0\n",
       "\\end{enumerate*}\n",
       "\n",
       "\\item[\\$value] 0.193358384270264\n",
       "\\item[\\$counts] \\begin{description*}\n",
       "\\item[function] 11\n",
       "\\item[gradient] 11\n",
       "\\end{description*}\n",
       "\n",
       "\\item[\\$convergence] 0\n",
       "\\item[\\$message] 'CONVERGENCE: REL\\_REDUCTION\\_OF\\_F <= FACTR*EPSMCH'\n",
       "\\end{description}\n"
      ],
      "text/markdown": [
       "$par\n",
       ":   1. 0.206723057983939\n",
       "2. -0.0184571841295454\n",
       "3. 3.38075908519519\n",
       "4. 0\n",
       "\n",
       "\n",
       "\n",
       "$value\n",
       ":   0.193358384270264\n",
       "$counts\n",
       ":   function\n",
       ":   11gradient\n",
       ":   11\n",
       "\n",
       "\n",
       "$convergence\n",
       ":   0\n",
       "$message\n",
       ":   'CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH'\n",
       "\n",
       "\n"
      ],
      "text/plain": [
       "$par\n",
       "[1]  0.20672306 -0.01845718  3.38075909  0.00000000\n",
       "\n",
       "$value\n",
       "[1] 0.1933584\n",
       "\n",
       "$counts\n",
       "function gradient \n",
       "      11       11 \n",
       "\n",
       "$convergence\n",
       "[1] 0\n",
       "\n",
       "$message\n",
       "[1] \"CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH\"\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "#load libraries\n",
    "library(readr) # for reading in data\n",
    "library(dplyr) # for data cleaning\n",
    "library(purrr) # for functional programming\n",
    "library(forcats) # for recoding factors\n",
    "library(limSolve) # for solving linear equations\n",
    "library(sqldf)\n",
    "library(XML)\n",
    "library(RCurl)\n",
    "library(elo)\n",
    "\n",
    "\n",
    "#Mens ELO Code\n",
    "CompactResults <- read.csv(\"../input/march-machine-learning-mania-2024/MRegularSeasonCompactResults.csv\" )\n",
    "\n",
    "test <- function(params) {\n",
    "  K = params[1]\n",
    "  loc = params[2]\n",
    "  score = params[3]\n",
    "  date = params[4]\n",
    "  for (year in min(CompactResults$Season):max(CompactResults$Season)) {\n",
    "    results <- CompactResults[which(CompactResults$Season == year),]\n",
    "    #Remove rows with NA, NaN, or Inf in critical columns\n",
    "    results <- results[!is.na(results$WScore) & !is.na(results$LScore) \n",
    "                       & is.finite(results$WScore) & is.finite(results$LScore), ]\n",
    "    results <- results[is.finite(results$DayNum),]\n",
    "    #Add result col for scoring elo, 1 for win, 0.5 for ot win\n",
    "    results$result <- ifelse(results$NumOT > 0, 0.5, 1)\n",
    "    #results$result <- score(results$WScore, results$LScore)\n",
    "    \n",
    "    #Add score margin, half margin if overtime\n",
    "    results$Margin <- ifelse(results$NumOT >0, 0.5*(results$WScore - results$LScore),\n",
    "                             results$WScore - results$LScore)\n",
    "    #Cap off margin to exclude blowouts\n",
    "    margin_cap = 25\n",
    "    results$Margin <- pmin(results$Margin, margin_cap)\n",
    "    \n",
    "    #Add Location value, 1 for home win, -1 for away win, 0 for neutral\n",
    "    results$Loc <- ifelse(results$WLoc == \"H\", -1, \n",
    "                          ifelse(results$WLoc == \"A\", 1, 0)) * loc\n",
    "    \n",
    "    #Reverse Day Num so regressed for earlier games\n",
    "    results$ReverseDayNum <- (max(results$DayNum) + 1) - results$DayNum \n",
    "    \n",
    "    \n",
    "    #Confirm data is clean\n",
    "    results <- results[is.finite(results$Loc) & is.finite(results$DayNum),]\n",
    "    \n",
    "    #Create the elo model\n",
    "    elo_model <- elo.run(data = results, \n",
    "                         formula = result ~ \n",
    "                           adjust(as.character(WTeamID), Loc)\n",
    "                         + as.character(LTeamID) + \n",
    "                           regress(ReverseDayNum, 1500, date), \n",
    "                         k = (K + (results$Margin*score)) )\n",
    "    \n",
    "    #Expand elo model to data frame\n",
    "    elo_results <- elo_model %>%\n",
    "      as.data.frame()\n",
    "    #Combine results data with elo data\n",
    "    results2 <- cbind(results, elo_results)\n",
    "    \n",
    "    \n",
    "    #Test on 2nd half of season\n",
    "    mid_date <- median(results$DayNum)\n",
    "    test_model <- results[\n",
    "      which(results$DayNum > mid_date),]\n",
    "    results3 <- merge(x = results2, y = test_model[c(\"Season\", \"DayNum\",\n",
    "                                                         \"WTeamID\",\"LTeamID\")], \n",
    "                      by = c(\"Season\", \"DayNum\",\"WTeamID\", \"LTeamID\"), all.y = TRUE)\n",
    "    \n",
    "    #Final elos function, add year and team id\n",
    "    final_elos <- as.data.frame(final.elos(elo_model))\n",
    "    names(final_elos)[1] <- \"ELO\"\n",
    "    final_elos$Season <- year\n",
    "    final_elos$TeamID <- row.names(final_elos)\n",
    "    final_elos$TeamID <- as.integer(row.names(final_elos))  \n",
    "    \n",
    "    \n",
    "    #If first year, create final elo dataframe otherwise add final elo for every year\n",
    "    ifelse(year == min(CompactResults$Season), final_elo <- final_elos, \n",
    "           final_elo <- rbind(final_elo, final_elos))\n",
    "    #If first year, create all games dataframe, otherwise add results2 for every year\n",
    "    ifelse(year == min(CompactResults$Season), all_games <- results2, \n",
    "           all_games <- rbind(all_games, results2))\n",
    "  }\n",
    "  final_elo <<- final_elo\n",
    "  all_games <<- na.omit(all_games)\n",
    "  results3$error <- (results3$result - results3$p.A)^2\n",
    "  errorVal <- sum(results3$error)/nrow(results3)\n",
    "  \n",
    "  #Confirm data is finite\n",
    "  if (!is.finite(errorVal)) {\n",
    "    warning(\"Non-finite value encountered. Returning a large number instead.\")\n",
    "    return(1e6)  # Return a large but finite value to indicate a poor fit\n",
    "  }\n",
    "  return(errorVal)\n",
    "}\n",
    "\n",
    "optim(par=c(0,0,0,0), fn=test, \n",
    "      lower = c(0,-Inf,-Inf,0), upper = c(Inf,Inf,Inf,1), method=\"L-BFGS-B\")\n",
    "FinalElo_M <- final_elo %>%\n",
    "  group_by(Season) %>%\n",
    "  arrange(Season, desc(ELO)) %>%\n",
    "  mutate(Rank = dense_rank(desc(ELO))) %>%\n",
    "  ungroup()\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bf2adfc9",
   "metadata": {
    "papermill": {
     "duration": 0.02182,
     "end_time": "2024-03-21T00:26:08.494994",
     "exception": false,
     "start_time": "2024-03-21T00:26:08.473174",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Example ELO\n",
    "ELO sorted for 2024"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "af8eac4c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:08.545485Z",
     "iopub.status.busy": "2024-03-21T00:26:08.543728Z",
     "iopub.status.idle": "2024-03-21T00:26:08.819649Z",
     "shell.execute_reply": "2024-03-21T00:26:08.817437Z"
    },
    "papermill": {
     "duration": 0.31237,
     "end_time": "2024-03-21T00:26:08.822457",
     "exception": false,
     "start_time": "2024-03-21T00:26:08.510087",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A data.frame: 25 × 5</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>TeamID</th><th scope=col>ELO</th><th scope=col>Season</th><th scope=col>Rank</th><th scope=col>TeamName</th></tr>\n",
       "\t<tr><th></th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>1</th><td>1163</td><td>1910.363</td><td>2024</td><td> 1</td><td>Connecticut   </td></tr>\n",
       "\t<tr><th scope=row>2</th><td>1120</td><td>1906.488</td><td>2024</td><td> 2</td><td>Auburn        </td></tr>\n",
       "\t<tr><th scope=row>3</th><td>1235</td><td>1880.730</td><td>2024</td><td> 3</td><td>Iowa St       </td></tr>\n",
       "\t<tr><th scope=row>4</th><td>1222</td><td>1877.257</td><td>2024</td><td> 4</td><td>Houston       </td></tr>\n",
       "\t<tr><th scope=row>5</th><td>1345</td><td>1855.425</td><td>2024</td><td> 5</td><td>Purdue        </td></tr>\n",
       "\t<tr><th scope=row>6</th><td>1314</td><td>1841.036</td><td>2024</td><td> 6</td><td>North Carolina</td></tr>\n",
       "\t<tr><th scope=row>7</th><td>1228</td><td>1829.313</td><td>2024</td><td> 7</td><td>Illinois      </td></tr>\n",
       "\t<tr><th scope=row>8</th><td>1112</td><td>1826.533</td><td>2024</td><td> 8</td><td>Arizona       </td></tr>\n",
       "\t<tr><th scope=row>9</th><td>1181</td><td>1816.886</td><td>2024</td><td> 9</td><td>Duke          </td></tr>\n",
       "\t<tr><th scope=row>10</th><td>1211</td><td>1805.479</td><td>2024</td><td>10</td><td>Gonzaga       </td></tr>\n",
       "\t<tr><th scope=row>11</th><td>1397</td><td>1803.672</td><td>2024</td><td>11</td><td>Tennessee     </td></tr>\n",
       "\t<tr><th scope=row>12</th><td>1388</td><td>1789.056</td><td>2024</td><td>12</td><td>St Mary's CA  </td></tr>\n",
       "\t<tr><th scope=row>13</th><td>1307</td><td>1785.853</td><td>2024</td><td>13</td><td>New Mexico    </td></tr>\n",
       "\t<tr><th scope=row>14</th><td>1166</td><td>1785.622</td><td>2024</td><td>14</td><td>Creighton     </td></tr>\n",
       "\t<tr><th scope=row>15</th><td>1246</td><td>1785.173</td><td>2024</td><td>15</td><td>Kentucky      </td></tr>\n",
       "\t<tr><th scope=row>16</th><td>1241</td><td>1783.581</td><td>2024</td><td>16</td><td>James Madison </td></tr>\n",
       "\t<tr><th scope=row>17</th><td>1213</td><td>1767.462</td><td>2024</td><td>17</td><td>Grand Canyon  </td></tr>\n",
       "\t<tr><th scope=row>18</th><td>1232</td><td>1766.361</td><td>2024</td><td>18</td><td>Indiana St    </td></tr>\n",
       "\t<tr><th scope=row>19</th><td>1179</td><td>1760.331</td><td>2024</td><td>19</td><td>Drake         </td></tr>\n",
       "\t<tr><th scope=row>20</th><td>1196</td><td>1758.114</td><td>2024</td><td>20</td><td>Florida       </td></tr>\n",
       "\t<tr><th scope=row>21</th><td>1194</td><td>1757.404</td><td>2024</td><td>21</td><td>FL Atlantic   </td></tr>\n",
       "\t<tr><th scope=row>22</th><td>1270</td><td>1750.226</td><td>2024</td><td>22</td><td>McNeese St    </td></tr>\n",
       "\t<tr><th scope=row>23</th><td>1361</td><td>1748.922</td><td>2024</td><td>23</td><td>San Diego St  </td></tr>\n",
       "\t<tr><th scope=row>24</th><td>1160</td><td>1746.780</td><td>2024</td><td>24</td><td>Colorado      </td></tr>\n",
       "\t<tr><th scope=row>25</th><td>1305</td><td>1743.433</td><td>2024</td><td>25</td><td>Nevada        </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A data.frame: 25 × 5\n",
       "\\begin{tabular}{r|lllll}\n",
       "  & TeamID & ELO & Season & Rank & TeamName\\\\\n",
       "  & <int> & <dbl> & <int> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t1 & 1163 & 1910.363 & 2024 &  1 & Connecticut   \\\\\n",
       "\t2 & 1120 & 1906.488 & 2024 &  2 & Auburn        \\\\\n",
       "\t3 & 1235 & 1880.730 & 2024 &  3 & Iowa St       \\\\\n",
       "\t4 & 1222 & 1877.257 & 2024 &  4 & Houston       \\\\\n",
       "\t5 & 1345 & 1855.425 & 2024 &  5 & Purdue        \\\\\n",
       "\t6 & 1314 & 1841.036 & 2024 &  6 & North Carolina\\\\\n",
       "\t7 & 1228 & 1829.313 & 2024 &  7 & Illinois      \\\\\n",
       "\t8 & 1112 & 1826.533 & 2024 &  8 & Arizona       \\\\\n",
       "\t9 & 1181 & 1816.886 & 2024 &  9 & Duke          \\\\\n",
       "\t10 & 1211 & 1805.479 & 2024 & 10 & Gonzaga       \\\\\n",
       "\t11 & 1397 & 1803.672 & 2024 & 11 & Tennessee     \\\\\n",
       "\t12 & 1388 & 1789.056 & 2024 & 12 & St Mary's CA  \\\\\n",
       "\t13 & 1307 & 1785.853 & 2024 & 13 & New Mexico    \\\\\n",
       "\t14 & 1166 & 1785.622 & 2024 & 14 & Creighton     \\\\\n",
       "\t15 & 1246 & 1785.173 & 2024 & 15 & Kentucky      \\\\\n",
       "\t16 & 1241 & 1783.581 & 2024 & 16 & James Madison \\\\\n",
       "\t17 & 1213 & 1767.462 & 2024 & 17 & Grand Canyon  \\\\\n",
       "\t18 & 1232 & 1766.361 & 2024 & 18 & Indiana St    \\\\\n",
       "\t19 & 1179 & 1760.331 & 2024 & 19 & Drake         \\\\\n",
       "\t20 & 1196 & 1758.114 & 2024 & 20 & Florida       \\\\\n",
       "\t21 & 1194 & 1757.404 & 2024 & 21 & FL Atlantic   \\\\\n",
       "\t22 & 1270 & 1750.226 & 2024 & 22 & McNeese St    \\\\\n",
       "\t23 & 1361 & 1748.922 & 2024 & 23 & San Diego St  \\\\\n",
       "\t24 & 1160 & 1746.780 & 2024 & 24 & Colorado      \\\\\n",
       "\t25 & 1305 & 1743.433 & 2024 & 25 & Nevada        \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A data.frame: 25 × 5\n",
       "\n",
       "| <!--/--> | TeamID &lt;int&gt; | ELO &lt;dbl&gt; | Season &lt;int&gt; | Rank &lt;int&gt; | TeamName &lt;chr&gt; |\n",
       "|---|---|---|---|---|---|\n",
       "| 1 | 1163 | 1910.363 | 2024 |  1 | Connecticut    |\n",
       "| 2 | 1120 | 1906.488 | 2024 |  2 | Auburn         |\n",
       "| 3 | 1235 | 1880.730 | 2024 |  3 | Iowa St        |\n",
       "| 4 | 1222 | 1877.257 | 2024 |  4 | Houston        |\n",
       "| 5 | 1345 | 1855.425 | 2024 |  5 | Purdue         |\n",
       "| 6 | 1314 | 1841.036 | 2024 |  6 | North Carolina |\n",
       "| 7 | 1228 | 1829.313 | 2024 |  7 | Illinois       |\n",
       "| 8 | 1112 | 1826.533 | 2024 |  8 | Arizona        |\n",
       "| 9 | 1181 | 1816.886 | 2024 |  9 | Duke           |\n",
       "| 10 | 1211 | 1805.479 | 2024 | 10 | Gonzaga        |\n",
       "| 11 | 1397 | 1803.672 | 2024 | 11 | Tennessee      |\n",
       "| 12 | 1388 | 1789.056 | 2024 | 12 | St Mary's CA   |\n",
       "| 13 | 1307 | 1785.853 | 2024 | 13 | New Mexico     |\n",
       "| 14 | 1166 | 1785.622 | 2024 | 14 | Creighton      |\n",
       "| 15 | 1246 | 1785.173 | 2024 | 15 | Kentucky       |\n",
       "| 16 | 1241 | 1783.581 | 2024 | 16 | James Madison  |\n",
       "| 17 | 1213 | 1767.462 | 2024 | 17 | Grand Canyon   |\n",
       "| 18 | 1232 | 1766.361 | 2024 | 18 | Indiana St     |\n",
       "| 19 | 1179 | 1760.331 | 2024 | 19 | Drake          |\n",
       "| 20 | 1196 | 1758.114 | 2024 | 20 | Florida        |\n",
       "| 21 | 1194 | 1757.404 | 2024 | 21 | FL Atlantic    |\n",
       "| 22 | 1270 | 1750.226 | 2024 | 22 | McNeese St     |\n",
       "| 23 | 1361 | 1748.922 | 2024 | 23 | San Diego St   |\n",
       "| 24 | 1160 | 1746.780 | 2024 | 24 | Colorado       |\n",
       "| 25 | 1305 | 1743.433 | 2024 | 25 | Nevada         |\n",
       "\n"
      ],
      "text/plain": [
       "   TeamID ELO      Season Rank TeamName      \n",
       "1  1163   1910.363 2024    1   Connecticut   \n",
       "2  1120   1906.488 2024    2   Auburn        \n",
       "3  1235   1880.730 2024    3   Iowa St       \n",
       "4  1222   1877.257 2024    4   Houston       \n",
       "5  1345   1855.425 2024    5   Purdue        \n",
       "6  1314   1841.036 2024    6   North Carolina\n",
       "7  1228   1829.313 2024    7   Illinois      \n",
       "8  1112   1826.533 2024    8   Arizona       \n",
       "9  1181   1816.886 2024    9   Duke          \n",
       "10 1211   1805.479 2024   10   Gonzaga       \n",
       "11 1397   1803.672 2024   11   Tennessee     \n",
       "12 1388   1789.056 2024   12   St Mary's CA  \n",
       "13 1307   1785.853 2024   13   New Mexico    \n",
       "14 1166   1785.622 2024   14   Creighton     \n",
       "15 1246   1785.173 2024   15   Kentucky      \n",
       "16 1241   1783.581 2024   16   James Madison \n",
       "17 1213   1767.462 2024   17   Grand Canyon  \n",
       "18 1232   1766.361 2024   18   Indiana St    \n",
       "19 1179   1760.331 2024   19   Drake         \n",
       "20 1196   1758.114 2024   20   Florida       \n",
       "21 1194   1757.404 2024   21   FL Atlantic   \n",
       "22 1270   1750.226 2024   22   McNeese St    \n",
       "23 1361   1748.922 2024   23   San Diego St  \n",
       "24 1160   1746.780 2024   24   Colorado      \n",
       "25 1305   1743.433 2024   25   Nevada        "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "MTeams <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/MTeams.csv\" , sep = ',')\n",
    "elo_2024 <- FinalElo_M %>% filter(Season == 2024)\n",
    "Final_elo_2024 <- merge(elo_2024, MTeams[, c(\"TeamID\", \"TeamName\")], \n",
    "                        by.x = \"TeamID\", by.y = \"TeamID\", all.x = TRUE)\n",
    "Final_elo_2024 <- Final_elo_2024 %>% arrange(Rank, desc = FALSE)\n",
    "head(n = 25, Final_elo_2024)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5d60b72c",
   "metadata": {
    "papermill": {
     "duration": 0.013256,
     "end_time": "2024-03-21T00:26:08.849262",
     "exception": false,
     "start_time": "2024-03-21T00:26:08.836006",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Creating Metrics\n",
    "### Using the compact and detailed regular season results, create 2 dataframes of metrics sorted by team and season\n",
    "Simple metrics based on compact results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "12b3d18b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:08.882046Z",
     "iopub.status.busy": "2024-03-21T00:26:08.880255Z",
     "iopub.status.idle": "2024-03-21T00:26:21.594194Z",
     "shell.execute_reply": "2024-03-21T00:26:21.591223Z"
    },
    "papermill": {
     "duration": 12.734132,
     "end_time": "2024-03-21T00:26:21.597421",
     "exception": false,
     "start_time": "2024-03-21T00:26:08.863289",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Load libraries\n",
    "library(readr) # for reading in data\n",
    "library(tidyr)\n",
    "library(dplyr) # for data cleaning\n",
    "library(purrr) # for functional programming\n",
    "library(forcats) # for recoding factors\n",
    "library(limSolve) # for solving linear equations\n",
    "\n",
    "CompactResults <- read.csv(\"../input/march-machine-learning-mania-2024/MRegularSeasonCompactResults.csv\" )\n",
    "DetailedResults <- read.csv(\"../input/march-machine-learning-mania-2024/MRegularSeasonDetailedResults.csv\" )\n",
    "CompactResults <- CompactResults %>% filter(Season >= min(DetailedResults$Season))\n",
    "\n",
    "#Mens Basic Metrics\n",
    "\n",
    "ELO <- FinalElo_M\n",
    "\n",
    "suppressMessages(\n",
    "for (year in min(CompactResults$Season):max(CompactResults$Season)) {\n",
    "  data <- CompactResults[which(CompactResults$Season == year),]\n",
    "  elo_season <- ELO[which(ELO$Season == year),]\n",
    "  #Data when winning\n",
    "  wins_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WPts_for = sum(WScore), WPts_against = sum(LScore), \n",
    "              WPts_diff = mean(WScore - LScore), Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #Data when losing\n",
    "  loss_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LPts_for = sum(LScore), LPts_against = sum(WScore), \n",
    "              LPts_diff = mean(LScore - WScore), Losses = n(),\n",
    "              LBlowouts = sum((WScore-LScore) >= 25 ),\n",
    "              LClose = sum((WScore-LScore) <= 5 )) %>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and clean\n",
    "  results <- merge(wins_df, loss_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  results$Wins[is.na(results$Wins)] <- 0\n",
    "  results$Losses[is.na(results$Losses)] <- 0\n",
    "  #Create winning percentage, points for, and points against cols\n",
    "  results <- results %>% \n",
    "    group_by(TeamID, Season) %>% \n",
    "    mutate(Games = Wins+Losses, \n",
    "           Win_pct = Wins/(Wins+Losses), \n",
    "           Pts_for = (WPts_for+LPts_for)/(Wins+Losses), \n",
    "           Pts_against = (WPts_against+LPts_against)/(Wins+Losses),\n",
    "           Pts_diff = (WPts_diff*Wins+LPts_diff*Losses)/(Wins+Losses)) %>% \n",
    "    select(Season, TeamID, Games, Win_pct, Pts_for, Pts_against, Pts_diff, LBlowouts, LClose)\n",
    "  #Raw SOS (based on opponent winning percentage)\n",
    "  raw_sosW <- data %>%\n",
    "    left_join(results, by  = c(\"LTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WSOS = mean(Win_pct), WNum = n()) %>% \n",
    "    rename(TeamID = WTeamID)\n",
    "  raw_sosL <- data %>%\n",
    "    left_join(results, by  = c(\"WTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LSOS = mean(Win_pct), LNum = n()) %>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  raw_sos <- merge(raw_sosW, raw_sosL, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  raw_sos$WSOS[is.na(raw_sos$WSOS)] <- 0\n",
    "  raw_sos$LSOS[is.na(raw_sos$LSOS)] <- 0\n",
    "  raw_sos$WNum[is.na(raw_sos$WNum)] <- 0\n",
    "  raw_sos$LNum[is.na(raw_sos$LNum)] <- 0\n",
    "  raw_sos <- raw_sos %>% \n",
    "    mutate(rawSOS = ((WSOS*WNum)+(LSOS*LNum))/(WNum+LNum))\n",
    "  #ELO SOS (based on opponent elo from prior calculations)\n",
    "  elo_sosW <- data %>%\n",
    "    left_join(elo_season, by  = c(\"LTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WELOSOS = mean(ELO), WNum = n()) %>% \n",
    "    rename(TeamID = WTeamID)\n",
    "  elo_sosL <- data %>%\n",
    "    left_join(elo_season, by  = c(\"WTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LELOSOS = mean(ELO), LNum = n()) %>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  elo_sos <- merge(elo_sosW, elo_sosL, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  elo_sos$WELOSOS[is.na(elo_sos$WELOSOS)] <- 0\n",
    "  elo_sos$LELOSOS[is.na(elo_sos$LELOSOS)] <- 0\n",
    "  elo_sos$WNum[is.na(elo_sos$WNum)] <- 0\n",
    "  elo_sos$LNum[is.na(elo_sos$LNum)] <- 0\n",
    "  elo_sos <- elo_sos %>% \n",
    "    mutate(ELOSOS = ((WELOSOS*WNum)+(LELOSOS*LNum))/(WNum+LNum))\n",
    "  #All SOS data\n",
    "  SOS <- merge(elo_sos, raw_sos, by = c(\"TeamID\", \"Season\"), all = TRUE) %>%\n",
    "    select(Season, TeamID, rawSOS, ELOSOS)\n",
    "  \n",
    "   #Wins vs top 50 teams\n",
    "  WOppElo <- data %>% \n",
    "    left_join(ELO, by = c(\"LTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(WTeamID, Season) %>% \n",
    "    rename(LRank = Rank) %>% \n",
    "    filter(LRank <= 50) %>% \n",
    "    summarize(Quad1W = n()) %>% \n",
    "    rename(TeamID = WTeamID)\n",
    "  #Loss vs top 50 teams\n",
    "  LOppElo <- data %>% \n",
    "    left_join(ELO, by = c(\"WTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(LTeamID, Season) %>% \n",
    "    rename(WRank = Rank) %>% \n",
    "    filter(WRank <= 50) %>% \n",
    "    summarize(Quad1L = n())%>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  #Record vs top 50 teams\n",
    "  OppElo <- merge(WOppElo, LOppElo, by = c(\"TeamID\", \"Season\"), all = TRUE) %>%\n",
    "    mutate(Quad1Rec = Quad1W/(Quad1W + Quad1L), Quad1Games = (Quad1W + Quad1L)) %>%\n",
    "    mutate(Quad1Rec = replace_na(Quad1Rec, 0), Quad1Games = replace_na(Quad1Games, 0)) %>% \n",
    "    select(Season, TeamID, Quad1Rec, Quad1Games)\n",
    "  \n",
    "  #Merge with SOS\n",
    "  SOS_Q1 <- SOS %>% left_join(OppElo, by = c(\"Season\", \"TeamID\"))\n",
    "  #All simple team metrics\n",
    "  results <- results %>% \n",
    "    left_join(SOS_Q1, by = c(\"Season\", \"TeamID\"))\n",
    "  #If first year, create final table, otherwise add data\n",
    "  ifelse(year == min(CompactResults$Season), SimpleMetrics <- results, \n",
    "         SimpleMetrics <- rbind(SimpleMetrics, results))\n",
    "})\n",
    "SimpleMetrics_M <- SimpleMetrics"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "01d8a3fe",
   "metadata": {
    "papermill": {
     "duration": 0.01607,
     "end_time": "2024-03-21T00:26:21.627152",
     "exception": false,
     "start_time": "2024-03-21T00:26:21.611082",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Detailed metrics based on detailed results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "e02505b0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:21.658181Z",
     "iopub.status.busy": "2024-03-21T00:26:21.656138Z",
     "iopub.status.idle": "2024-03-21T00:26:38.898310Z",
     "shell.execute_reply": "2024-03-21T00:26:38.895841Z"
    },
    "papermill": {
     "duration": 17.260866,
     "end_time": "2024-03-21T00:26:38.901108",
     "exception": false,
     "start_time": "2024-03-21T00:26:21.640242",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Mens Detailed Metrics\n",
    "suppressMessages(\n",
    "for (year in min(DetailedResults$Season):max(DetailedResults$Season)) {\n",
    "  data <- DetailedResults[which(DetailedResults$Season == year),]\n",
    "  #fg pct, 3pt pct, #3pt att/total att, ft att\n",
    "  #In wins\n",
    "  Wfg_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WFgPct = (sum(WFGM))/(sum(WFGA)), \n",
    "              W3PtPct = (sum(WFGM3))/(sum(WFGA3)), \n",
    "              W3PtShots = (sum(WFGA3))/(sum(WFGA)), \n",
    "              WFtPct = (sum(WFTM))/(sum(WFTA)),\n",
    "              WFtA = (sum(WFTA)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #In losses \n",
    "  Lfg_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LFgPct = (sum(LFGM))/(sum(LFGA)), \n",
    "              L3PtPct = (sum(LFGM3))/(sum(LFGA3)), \n",
    "              L3PtShots = (sum(LFGA3))/(sum(LFGA)), \n",
    "              LFtPct = (sum(LFTM))/(sum(LFTA)),\n",
    "              LFtA = (sum(LFTA)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  fg_df <- merge(Wfg_df, Lfg_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  fg_df$Wins[is.na(fg_df$Wins)] <- 0\n",
    "  fg_df$Losses[is.na(fg_df$Losses)] <- 0\n",
    "  fg_df <- fg_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(FgPct = (WFgPct*Wins+LFgPct*Losses)/(Wins+Losses), \n",
    "           ThreePtPct = (W3PtPct*Wins+L3PtPct*Losses)/(Wins+Losses),\n",
    "           ThreePtShots = (W3PtShots*Wins+L3PtShots*Losses)/(Wins+Losses),\n",
    "           FtPct = (WFtPct*Wins+LFtPct*Losses)/(Wins+Losses),\n",
    "           FtA = (WFtA*Wins+LFtA*Losses)/(Wins+Losses),\n",
    "           Games = (Wins + Losses))\n",
    "  #opp in wins\n",
    "  OppWfg_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(OppWFgPct = (sum(LFGM))/(sum(LFGA)), \n",
    "              OppW3PtPct = (sum(LFGM3))/(sum(LFGA3)), \n",
    "              OppW3PtShots = (sum(LFGA3))/(sum(LFGA)),\n",
    "              OppWFtA = (sum(LFTA)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #opp in losses\n",
    "  OppLfg_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(OppLFgPct = (sum(WFGM))/(sum(WFGA)), \n",
    "              OppL3PtPct = (sum(WFGM3))/(sum(WFGA3)), \n",
    "              OppL3PtShots = (sum(WFGA3))/(sum(WFGA)), \n",
    "              OppLFtA = (sum(WFTA)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  opp_fg_df <- merge(OppWfg_df, OppLfg_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  opp_fg_df$Wins[is.na(opp_fg_df$Wins)] <- 0\n",
    "  opp_fg_df$Losses[is.na(opp_fg_df$Losses)] <- 0\n",
    "  opp_fg_df <- opp_fg_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(OppFgPct = (OppWFgPct*Wins+OppLFgPct*Losses)/(Wins+Losses), \n",
    "           OppThreePtPct = (OppW3PtPct*Wins+OppL3PtPct*Losses)/(Wins+Losses),\n",
    "           OppThreePtShots = (OppW3PtShots*Wins+OppL3PtShots*Losses)/(Wins+Losses),\n",
    "           OppFtA = (OppWFtA*Wins+OppLFtA*Losses)/(Wins+Losses)) %>%\n",
    "    select(-Wins, -Losses)\n",
    "  fg_results <-  merge(fg_df, opp_fg_df, by = c(\"TeamID\", \"Season\"), all = TRUE) %>% \n",
    "    select(Season, TeamID, FgPct, ThreePtPct, ThreePtShots, FtPct, FtA,\n",
    "           OppFgPct, OppThreePtPct, OppThreePtShots, OppFtA, Wins, Losses, Games)\n",
    "  #reb, oreb/opponent reb, blocks + steals, turnovers, asst/to\n",
    "  #Win stats\n",
    "  Wdef_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WReb = (sum(WOR + WDR)/n()), \n",
    "              WOReb = sum(WOR)/n(),\n",
    "              WORebRat = (sum(WOR/LDR)/n()),\n",
    "              WStl = (sum(WStl)/n()),\n",
    "              WBlk = (sum(WBlk)/n()), \n",
    "              WTurn = (sum(WTO)/n()), \n",
    "              WTurnRat = (sum(WTO/LTO)/n()),\n",
    "              WAsstRat = (sum(WAst/WTO)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #Loss stats\n",
    "  Ldef_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LReb = (sum(LOR + LDR)/n()), \n",
    "              LOReb = sum(LOR)/n(),\n",
    "              LORebRat = (sum(LOR/(LOR +WDR))/n()),\n",
    "              LStl = (sum(LStl)/n()),\n",
    "              LBlk = (sum(LBlk)/n()),  \n",
    "              LTurn = (sum(LTO)/n()), \n",
    "              LTurnRat = (sum(LTO/WTO)/n()),\n",
    "              LAsstRat = (sum(LAst/LTO)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  def_df <- merge(Wdef_df, Ldef_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  def_df$Wins[is.na(def_df$Wins)] <- 0\n",
    "  def_df$Losses[is.na(def_df$Losses)] <- 0\n",
    "  def_df <- def_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(Reb = (WReb*Wins+LReb*Losses)/(Wins+Losses),\n",
    "           OReb = (WOReb*Wins+LOReb*Losses)/(Wins+Losses),\n",
    "           ORebRat = (WORebRat*Wins+LORebRat*Losses)/(Wins+Losses),\n",
    "           Stl = (WStl*Wins+ LStl*Losses)/(Wins+Losses),\n",
    "           Blk = (WBlk*Wins+ LBlk*Losses)/(Wins+Losses),\n",
    "           TO = (WTurn*Wins+ LTurn*Losses)/(Wins+Losses),\n",
    "           TurnRat = (WTurnRat*Wins+ LTurnRat*Losses)/(Wins+Losses),\n",
    "           AsstRat = (WAsstRat*Wins+ LAsstRat*Losses)/(Wins+Losses),\n",
    "           Games = (Wins + Losses))\n",
    "  #opp in wins \n",
    "  OppWdef_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(OppWOReb = (sum(LOR)/n()), \n",
    "              OppWORebRat = (sum(LOR/WDR)/n()),\n",
    "              OppWBlkStl = (sum(LBlk+LStl)/n()), \n",
    "              OppWAsstRat = (sum(LAst/LTO)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #opp in losses\n",
    "  OppLdef_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(OppLOReb = (sum(WOR)/n()), \n",
    "              OppLORebRat = (sum(WOR/LDR)/n()),\n",
    "              OppLBlkStl = (sum(WBlk+WStl)/n()), \n",
    "              OppLAsstRat = (sum(WAst/WTO)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  opp_def_df <- merge(OppWdef_df, OppLdef_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  opp_def_df$Wins[is.na(opp_def_df$Wins)] <- 0\n",
    "  opp_def_df$Losses[is.na(opp_def_df$Losses)] <- 0\n",
    "  opp_def_df <- opp_def_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(OppOReb = (OppWOReb*Wins+OppLOReb*Losses)/(Wins+Losses),\n",
    "           OppORebRat = (OppWORebRat*Wins+OppLORebRat*Losses)/(Wins+Losses),\n",
    "           OppBlkStl = (OppWBlkStl*Wins+ OppLBlkStl*Losses)/(Wins+Losses),\n",
    "           OppAsstRat = (OppWAsstRat*Wins+ OppLAsstRat*Losses)/(Wins+Losses)) %>% \n",
    "    select(-Wins, -Losses)\n",
    "  def_results <-  merge(def_df, opp_def_df, by = c(\"TeamID\", \"Season\"), all = TRUE) %>%\n",
    "    select(Season, TeamID, Reb, OReb, ORebRat, Stl, Blk, TO, TurnRat, AsstRat, \n",
    "           OppOReb, OppORebRat, OppBlkStl, OppAsstRat)\n",
    "  #Merge fg and def dataframes\n",
    "  results <- merge(fg_results, def_results, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  #If first year, create final table, otherwise add data\n",
    "  ifelse(year == min(CompactResults$Season), DetailedMetrics <- results, \n",
    "         DetailedMetrics <- rbind(DetailedMetrics, results))\n",
    "})\n",
    "DetailedMetrics_M <- DetailedMetrics"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6c41f224",
   "metadata": {
    "papermill": {
     "duration": 0.014024,
     "end_time": "2024-03-21T00:26:38.930059",
     "exception": false,
     "start_time": "2024-03-21T00:26:38.916035",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Predictors\n",
    "Merge all dataframes (elo, simple metrics, detailed metrics) to create a full dataframe of predictors"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "f1c4fa86",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:38.963007Z",
     "iopub.status.busy": "2024-03-21T00:26:38.959840Z",
     "iopub.status.idle": "2024-03-21T00:26:39.135082Z",
     "shell.execute_reply": "2024-03-21T00:26:39.132402Z"
    },
    "papermill": {
     "duration": 0.195852,
     "end_time": "2024-03-21T00:26:39.138683",
     "exception": false,
     "start_time": "2024-03-21T00:26:38.942831",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Merge All DataFrames\n",
    "#Merge Metrics\n",
    "Metrics <- merge(SimpleMetrics_M, DetailedMetrics_M, \n",
    "                 by = c(\"TeamID\", \"Season\", \"Games\"))\n",
    "#Merge metrics and ELO\n",
    "Predictors <- merge(Metrics, FinalElo_M, by = c(\"TeamID\", \"Season\"), all.x = TRUE) %>% \n",
    "  select(-Games)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "19dc620a",
   "metadata": {
    "papermill": {
     "duration": 0.01319,
     "end_time": "2024-03-21T00:26:39.165771",
     "exception": false,
     "start_time": "2024-03-21T00:26:39.152581",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## XGBoost\n",
    "### Set up dataframe for xgboost\n",
    "Merge NCAA tournament results with team data for each team"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "0821b388",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:39.197522Z",
     "iopub.status.busy": "2024-03-21T00:26:39.195458Z",
     "iopub.status.idle": "2024-03-21T00:26:42.399292Z",
     "shell.execute_reply": "2024-03-21T00:26:42.396214Z"
    },
    "papermill": {
     "duration": 3.224245,
     "end_time": "2024-03-21T00:26:42.403468",
     "exception": false,
     "start_time": "2024-03-21T00:26:39.179223",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n",
      "Attaching package: ‘xgboost’\n",
      "\n",
      "\n",
      "The following object is masked from ‘package:dplyr’:\n",
      "\n",
      "    slice\n",
      "\n",
      "\n"
     ]
    }
   ],
   "source": [
    "#Load libraries\n",
    "library(dplyr) # for data cleaning\n",
    "library(xgboost) #For modelling\n",
    "\n",
    "\n",
    "DetailedResults <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/MRegularSeasonDetailedResults.csv\" , sep = ',')\n",
    "NCAATourneyCompactResults <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/MNCAATourneyCompactResults.csv\" , sep = ',')\n",
    "NCAATourneyCompactResults <- NCAATourneyCompactResults %>% filter(Season >= min(DetailedResults$Season))\n",
    "NCAATourneySeeds <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/MNCAATourneySeeds.csv\" , sep = ',')\n",
    "NCAATourneySeeds <- NCAATourneySeeds %>% filter(Season >= min(DetailedResults$Season))\n",
    "Predictors <- Predictors\n",
    "\n",
    "#Set up df\n",
    "results <- NCAATourneyCompactResults\n",
    "results$Team1 <- ifelse(results$WTeamID < results$LTeamID, results$WTeamID, results$LTeamID)\n",
    "results$Team2 <- ifelse(results$WTeamID > results$LTeamID, results$WTeamID, results$LTeamID)\n",
    "results <- results %>% \n",
    "  left_join(Predictors, by = c(\"Team1\" = \"TeamID\", \"Season\")) %>% \n",
    "  rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, \n",
    "         T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, \n",
    "         T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, \n",
    "         T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,\n",
    "         T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, \n",
    "         T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, \n",
    "         T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, T1Stl = Stl, T1Blk = Blk,\n",
    "         T1TO = TO, T1TurnRat = TurnRat, T1AsstRat = AsstRat, T1OppOReb = OppOReb, T1OppORebRat = OppORebRat, \n",
    "         T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,\n",
    "         T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)\n",
    "results<- results %>% \n",
    "  left_join(Predictors, by = c(\"Team2\" = \"TeamID\", \"Season\")) %>% \n",
    "  rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against,\n",
    "         T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, \n",
    "         T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, \n",
    "         T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,\n",
    "         T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, \n",
    "         T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, \n",
    "         T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, T2Stl = Stl, T2Blk = Blk,\n",
    "         T2TO = TO, T2TurnRat = TurnRat, T2AsstRat = AsstRat, T2OppOReb = OppOReb, T2OppORebRat = OppORebRat, \n",
    "         T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,\n",
    "         T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)\n",
    "results <- results %>%\n",
    "  left_join(NCAATourneySeeds, by = c(\"Team1\" = \"TeamID\", \"Season\")) %>%\n",
    "  rename(Seed_T1 = Seed)\n",
    "results <- results %>%\n",
    "  left_join(NCAATourneySeeds, by = c(\"Team2\" = \"TeamID\", \"Season\")) %>%\n",
    "  rename(Seed_T2 = Seed)\n",
    "results$SeedNum_T1 <- as.numeric(substr(results$Seed_T1,2,3))\n",
    "results$SeedNum_T2 <- as.numeric(substr(results$Seed_T2,2,3))\n",
    "results$Seed_len1 <- substr(results$Seed_T1,1,3)\n",
    "results$Seed_len2 <- substr(results$Seed_T2,1,3)\n",
    "\n",
    "results$result <- ifelse(results$WTeamID < results$LTeamID, 1, 0)\n",
    "results$Score1 <- ifelse(results$WTeamID < results$LTeamID, results$WScore, results$LScore)\n",
    "results$Score2 <- ifelse(results$WTeamID > results$LTeamID, results$WScore, results$LScore)\n",
    "results <- results %>%\n",
    "  mutate(ELO_diff = T1ELO-T2ELO,\n",
    "        Seed_diff = SeedNum_T1 - SeedNum_T2,\n",
    "        Win_pct_dif = T1Win_pct - T2Win_pct,\n",
    "        PTS_for = T1Pts_for - T2Pts_for,\n",
    "        PTS_against = T1Pts_against - T2Pts_against,\n",
    "        ThreePtShots_diff = T1ThreePtShots - T2ThreePtShots,\n",
    "        Reb_diff = T1Reb - T2Reb,\n",
    "        ORebRate_diff = T1ORebRat - T2ORebRat,\n",
    "        OppORebRate_diff = T1OppORebRat - T2OppORebRat,\n",
    "        Turn_diff = T1TO - T2TO,\n",
    "        rawSOS_diff = T1rawSOS - T2rawSOS,\n",
    "        ELOSOS_diff = T1ELOSOS - T2ELOSOS,\n",
    "        Rank_diff = T1Rank - T2Rank,\n",
    "        Margin_diff = T1Pts_diff - T2Pts_diff)\n",
    "results <- results[which(results$Seed_len1 != results$Seed_len2),]"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "766bb179",
   "metadata": {
    "papermill": {
     "duration": 0.014535,
     "end_time": "2024-03-21T00:26:42.432596",
     "exception": false,
     "start_time": "2024-03-21T00:26:42.418061",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Perform XGBoost"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "1deb8d24",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:42.464468Z",
     "iopub.status.busy": "2024-03-21T00:26:42.462498Z",
     "iopub.status.idle": "2024-03-21T00:26:51.228391Z",
     "shell.execute_reply": "2024-03-21T00:26:51.226201Z"
    },
    "papermill": {
     "duration": 8.786106,
     "end_time": "2024-03-21T00:26:51.232403",
     "exception": false,
     "start_time": "2024-03-21T00:26:42.446297",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "set.seed(27)\n",
    "#Set Predictors\n",
    "predictors <- c(\"T1Win_pct\", \"T1Pts_for\", \"T1Pts_against\",\"T1Pts_diff\", \n",
    "                \"T1rawSOS\", \"T1ELOSOS\", \"T1FgPct\", \"T1ThreePtPct\", \"T1ThreePtShots\",\n",
    "                \"T1FtPct\", \"T1FtA\", \"T1OppFgPct\", \"T1OppThreePtPct\", \"T1OppThreePtShots\", \n",
    "                \"T1OppFtA\", \"T1Reb\", \"T1OReb\", \"T1ORebRat\", \"T1Stl\", \"T1Blk\",\n",
    "                \"T1TO\", \"T1TurnRat\", \"T1AsstRat\", \"T1OppOReb\", \"T1OppORebRat\", \"T1OppBlkStl\", \n",
    "                \"T1ELO\", \"T1Quad1Rec\", \"T1Quad1Games\", \"T2Win_pct\", \"T2Pts_for\", \n",
    "                \"T2Pts_against\", \"T2Pts_diff\",\"T2rawSOS\", \"T2ELOSOS\", \n",
    "                \"T2FgPct\", \"T2ThreePtPct\", \"T2ThreePtShots\", \"T2FtPct\", \n",
    "                \"T2FtA\", \"T2OppFgPct\", \"T2OppThreePtPct\", \"T2OppThreePtShots\", \n",
    "                \"T2OppFtA\", \"T2Reb\", \"T2OReb\", \"T2ORebRat\", \"T2Stl\", \"T2Blk\",\n",
    "                \"T2TO\", \"T2TurnRat\", \"T2AsstRat\", \"T2OppOReb\", \"T2OppORebRat\",\"T2OppBlkStl\",\n",
    "                \"T2ELO\", \"T2Quad1Rec\", \"T2Quad1Games\", \"ELO_diff\", \n",
    "                \"T1Wins\", \"T1Losses\", \"T2Wins\", \"T2Losses\", \"T1OppAsstRat\", \"T2OppAsstRat\",\n",
    "                \"T1Rank\", \"T2Rank\", \"PTS_for\", \"PTS_against\", \"Win_pct_dif\", \n",
    "                \"ThreePtShots_diff\", \"Reb_diff\", \"ORebRate_diff\", \"OppORebRate_diff\", \n",
    "                \"Turn_diff\",\"ELOSOS_diff\", \"Rank_diff\", \"Margin_diff\")\n",
    "#Unused: \"T1LBlowouts\", \"T2LBlowouts\", \"T1LClose\", \"T2LClose\", \"Seed_diff\", \"rawSOS_diff\" \n",
    "\n",
    "\n",
    "\n",
    "#Set features and label\n",
    "dtrain <- xgb.DMatrix(data = as.matrix(results[, predictors]), label = results$result)\n",
    "\n",
    "#Parameters\n",
    "params <- list(\n",
    "  objective = \"binary:logistic\",\n",
    "  booster = \"gbtree\",\n",
    "  eta = 0.025,\n",
    "  max_depth = 6,\n",
    "  subsample = 0.75,\n",
    "  colsample_bytree = 0.8\n",
    ")\n",
    "\n",
    "# Cross-validation\n",
    "cv_results <- xgb.cv(params = params,\n",
    "                     data = dtrain,\n",
    "                     nrounds = 2000,\n",
    "                     nfold = 5,\n",
    "                     metrics = \"logloss\",\n",
    "                     early_stopping_rounds = 20,\n",
    "                     maximize = FALSE,\n",
    "                     Prediction = TRUE,\n",
    "                     verbose = 0)\n",
    "# Extract the best number of rounds\n",
    "best_nrounds <- cv_results$best_iteration\n",
    "# Re-train the model on the full dataset using the best number of rounds\n",
    "final_model <- xgb.train(params = params,\n",
    "                         data = dtrain,\n",
    "                         nrounds = best_nrounds)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "262a7280",
   "metadata": {
    "papermill": {
     "duration": 0.013287,
     "end_time": "2024-03-21T00:26:51.258933",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.245646",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "### Print errors since 2018"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "e7d73045",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:51.289536Z",
     "iopub.status.busy": "2024-03-21T00:26:51.287549Z",
     "iopub.status.idle": "2024-03-21T00:26:51.467422Z",
     "shell.execute_reply": "2024-03-21T00:26:51.464720Z"
    },
    "papermill": {
     "duration": 0.199179,
     "end_time": "2024-03-21T00:26:51.471108",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.271929",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Season      error\n",
      "1   2018 0.07240996\n",
      "2   2019 0.06095102\n",
      "3   2021 0.06721801\n",
      "4   2022 0.09397357\n",
      "5   2023 0.08626921\n"
     ]
    }
   ],
   "source": [
    "ErrorTable <- data.frame(Season = numeric(), error = numeric())\n",
    "\n",
    "for (year in unique(results$Season)) {\n",
    "  data <- results[which(results$Season == year),]\n",
    "  dtest <- xgb.DMatrix(data = as.matrix(data[, predictors]))\n",
    "  predictions <- predict(final_model, dtest)\n",
    "  true_outcomes <- data$result\n",
    "  error <- mean((true_outcomes - predictions)^2)\n",
    "  year_error <- data.frame(Season = year, error = error)\n",
    "  ErrorTable <- rbind(ErrorTable, year_error)\n",
    "}\n",
    "\n",
    "ErrorTable <- ErrorTable %>% filter(Season >= 2018)\n",
    "print(ErrorTable)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ff4f51e9",
   "metadata": {
    "papermill": {
     "duration": 0.014219,
     "end_time": "2024-03-21T00:26:51.501201",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.486982",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "### Calculate 2023 accuracy vs. simple model (based on seeds)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "d4caabc1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:51.532543Z",
     "iopub.status.busy": "2024-03-21T00:26:51.530620Z",
     "iopub.status.idle": "2024-03-21T00:26:51.595677Z",
     "shell.execute_reply": "2024-03-21T00:26:51.592959Z"
    },
    "papermill": {
     "duration": 0.083988,
     "end_time": "2024-03-21T00:26:51.599086",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.515098",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[1] 0.952381\n",
      "[1] 0.6984127\n"
     ]
    }
   ],
   "source": [
    "#True Acc vs Chalk Acc 2023\n",
    "data <- results[which(results$Season == 2023),]\n",
    "true_outcomes <- data$result\n",
    "dtest <- xgb.DMatrix(data = as.matrix(data[, predictors]))\n",
    "predictions <- predict(final_model, dtest)\n",
    "data$pred1 <- ifelse(predictions >= 0.5, 1, 0)\n",
    "predictions1 <- data$pred1\n",
    "TrueAcc <-mean(predictions1 == true_outcomes)\n",
    "print(TrueAcc)\n",
    "\n",
    "data$Chalk <- ifelse(data$SeedNum_T1 <= data$SeedNum_T2, \n",
    "                     1, 0)\n",
    "predictions2 <- data$Chalk\n",
    "ChalkAcc <- mean(predictions2 == true_outcomes)\n",
    "print(ChalkAcc)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9f31ff7c",
   "metadata": {
    "papermill": {
     "duration": 0.014336,
     "end_time": "2024-03-21T00:26:51.627022",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.612686",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# CREATE BRACKET MENS\n",
    "## Set up bracket info\n",
    "Create round maps and initial round info"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "205aade0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:51.663912Z",
     "iopub.status.busy": "2024-03-21T00:26:51.660366Z",
     "iopub.status.idle": "2024-03-21T00:26:51.799129Z",
     "shell.execute_reply": "2024-03-21T00:26:51.793877Z"
    },
    "papermill": {
     "duration": 0.161795,
     "end_time": "2024-03-21T00:26:51.804319",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.642524",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Load libraries\n",
    "library(dplyr) # for data cleaning\n",
    "library(xgboost) #For modelling\n",
    "\n",
    "Seeds <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/2024_tourney_seeds.csv\" , sep = ',')\n",
    "MensSeeds <- Seeds %>% \n",
    "  filter(Tournament == \"M\")\n",
    "Sub <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/sample_submission.csv\" , sep = ',')\n",
    "Slots <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/MNCAATourneySeedRoundSlots.csv\" , sep = ',')\n",
    "MTeams <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/MTeams.csv\" , sep = ',')\n",
    "MTeams <- MTeams %>% select(TeamID, TeamName)\n",
    "\n",
    "#General\n",
    "Predictors_2024 <- Predictors %>% filter(Season == 2024)\n",
    "predictors <- c(\"T1Win_pct\", \"T1Pts_for\", \"T1Pts_against\",\"T1Pts_diff\", \n",
    "                \"T1rawSOS\", \"T1ELOSOS\", \"T1FgPct\", \"T1ThreePtPct\", \"T1ThreePtShots\",\n",
    "                \"T1FtPct\", \"T1FtA\", \"T1OppFgPct\", \"T1OppThreePtPct\", \"T1OppThreePtShots\", \n",
    "                \"T1OppFtA\", \"T1Reb\", \"T1OReb\", \"T1ORebRat\", \"T1Stl\", \"T1Blk\",\n",
    "                \"T1TO\", \"T1TurnRat\", \"T1AsstRat\", \"T1OppOReb\", \"T1OppORebRat\", \"T1OppBlkStl\", \n",
    "                \"T1ELO\", \"T1Quad1Rec\", \"T1Quad1Games\", \"T2Win_pct\", \"T2Pts_for\", \n",
    "                \"T2Pts_against\", \"T2Pts_diff\",\"T2rawSOS\", \"T2ELOSOS\", \n",
    "                \"T2FgPct\", \"T2ThreePtPct\", \"T2ThreePtShots\", \"T2FtPct\", \n",
    "                \"T2FtA\", \"T2OppFgPct\", \"T2OppThreePtPct\", \"T2OppThreePtShots\", \n",
    "                \"T2OppFtA\", \"T2Reb\", \"T2OReb\", \"T2ORebRat\", \"T2Stl\", \"T2Blk\",\n",
    "                \"T2TO\", \"T2TurnRat\", \"T2AsstRat\", \"T2OppOReb\", \"T2OppORebRat\",\"T2OppBlkStl\",\n",
    "                \"T2ELO\", \"T2Quad1Rec\", \"T2Quad1Games\", \"ELO_diff\", \n",
    "                \"T1Wins\", \"T1Losses\", \"T2Wins\", \"T2Losses\", \"T1OppAsstRat\", \"T2OppAsstRat\",\n",
    "                \"T1Rank\", \"T2Rank\", \"PTS_for\", \"PTS_against\", \"Win_pct_dif\", \n",
    "                \"ThreePtShots_diff\", \"Reb_diff\", \"ORebRate_diff\", \"OppORebRate_diff\", \n",
    "                \"Turn_diff\",\"ELOSOS_diff\", \"Rank_diff\", \"Margin_diff\")\n",
    "#Unused: \"T1LBlowouts\", \"T2LBlowouts\", \"T1LClose\", \"T2LClose\", \"Seed_diff\", \"rawSOS_diff\" \n",
    "\n",
    "#Seeding info\n",
    "initial_slots <- c(\n",
    "  'R1W1', 'R1W2', 'R1W3', 'R1W4', 'R1W5', 'R1W6', 'R1W7', 'R1W8',\n",
    "  'R1X1', 'R1X2', 'R1X3', 'R1X4', 'R1X5', 'R1X6', 'R1X7', 'R1X8',\n",
    "  'R1Y1', 'R1Y2', 'R1Y3', 'R1Y4', 'R1Y5', 'R1Y6', 'R1Y7', 'R1Y8',\n",
    "  'R1Z1', 'R1Z2', 'R1Z3', 'R1Z4', 'R1Z5', 'R1Z6', 'R1Z7', 'R1Z8'\n",
    ")\n",
    "\n",
    "initial_matchups <- list(\n",
    "  'R1W1' = c(\"01\", \"16\"),\n",
    "  'R1W2' = c(\"02\", \"15\"),\n",
    "  'R1W3' = c(\"03\", \"14\"),\n",
    "  'R1W4' = c(\"04\", \"13\"),\n",
    "  'R1W5' = c(\"05\", \"12\"),\n",
    "  'R1W6' = c(\"06\", \"11\"),\n",
    "  'R1W7' = c(\"07\", \"10\"),\n",
    "  'R1W8' = c(\"08\", \"09\"),\n",
    "  'R1X1' = c(\"01\", \"16\"),\n",
    "  'R1X2' = c(\"02\", \"15\"),\n",
    "  'R1X3' = c(\"03\", \"14\"),\n",
    "  'R1X4' = c(\"04\", \"13\"),\n",
    "  'R1X5' = c(\"05\", \"12\"),\n",
    "  'R1X6' = c(\"06\", \"11\"),\n",
    "  'R1X7' = c(\"07\", \"10\"),\n",
    "  'R1X8' = c(\"08\", \"09\"),\n",
    "  'R1Y1' = c(\"01\", \"16\"),\n",
    "  'R1Y2' = c(\"02\", \"15\"),\n",
    "  'R1Y3' = c(\"03\", \"14\"),\n",
    "  'R1Y4' = c(\"04\", \"13\"),\n",
    "  'R1Y5' = c(\"05\", \"12\"),\n",
    "  'R1Y6' = c(\"06\", \"11\"),\n",
    "  'R1Y7' = c(\"07\", \"10\"),\n",
    "  'R1Y8' = c(\"08\", \"09\"),\n",
    "  'R1Z1' = c(\"01\", \"16\"),\n",
    "  'R1Z2' = c(\"02\", \"15\"),\n",
    "  'R1Z3' = c(\"03\", \"14\"),\n",
    "  'R1Z4' = c(\"04\", \"13\"),\n",
    "  'R1Z5' = c(\"05\", \"12\"),\n",
    "  'R1Z6' = c(\"06\", \"11\"),\n",
    "  'R1Z7' = c(\"07\", \"10\"),\n",
    "  'R1Z8' = c(\"08\", \"09\")\n",
    ")\n",
    "\n",
    "\n",
    "round2_map <- list(\n",
    "  'R1W1' = 'R2W1', 'R1W8' = 'R2W1',\n",
    "  'R1W2' = 'R2W2', 'R1W7' = 'R2W2',\n",
    "  'R1W3' = 'R2W3', 'R1W6' = 'R2W3',\n",
    "  'R1W4' = 'R2W4', 'R1W5' = 'R2W4',\n",
    "  'R1X1' = 'R2X1', 'R1X8' = 'R2X1',\n",
    "  'R1X2' = 'R2X2', 'R1X7' = 'R2X2',\n",
    "  'R1X3' = 'R2X3', 'R1X6' = 'R2X3',\n",
    "  'R1X4' = 'R2X4', 'R1X5' = 'R2X4',\n",
    "  'R1Y1' = 'R2Y1', 'R1Y8' = 'R2Y1',\n",
    "  'R1Y2' = 'R2Y2', 'R1Y7' = 'R2Y2',\n",
    "  'R1Y3' = 'R2Y3', 'R1Y6' = 'R2Y3',\n",
    "  'R1Y4' = 'R2Y4', 'R1Y5' = 'R2Y4',\n",
    "  'R1Z1' = 'R2Z1', 'R1Z8' = 'R2Z1',\n",
    "  'R1Z2' = 'R2Z2', 'R1Z7' = 'R2Z2',\n",
    "  'R1Z3' = 'R2Z3', 'R1Z6' = 'R2Z3',\n",
    "  'R1Z4' = 'R2Z4', 'R1Z5' = 'R2Z4'\n",
    ")\n",
    "\n",
    "round3_map <- list(\n",
    "  'R2W1' = 'R3W1', 'R2W4' = 'R3W1',\n",
    "  'R2W2' = 'R3W2', 'R2W3' = 'R3W2',\n",
    "  'R2X1' = 'R3X1', 'R2X4' = 'R3X1',\n",
    "  'R2X2' = 'R3X2', 'R2X3' = 'R3X2',\n",
    "  'R2Y1' = 'R3Y1', 'R2Y4' = 'R3Y1',\n",
    "  'R2Y2' = 'R3Y2', 'R2Y3' = 'R3Y2',\n",
    "  'R2Z1' = 'R3Z1', 'R2Z4' = 'R3Z1',\n",
    "  'R2Z2' = 'R3Z2', 'R2Z3' = 'R3Z2'\n",
    ")\n",
    "\n",
    "round4_map <- list(\n",
    "  'R3W1' = 'R4W1', 'R3W2' = 'R4W1',\n",
    "  'R3X1' = 'R4X1', 'R3X2' = 'R4X1',\n",
    "  'R3Y1' = 'R4Y1', 'R3Y2' = 'R4Y1',\n",
    "  'R3Z1' = 'R4Z1', 'R3Z2' = 'R4Z1'\n",
    ")\n",
    "\n",
    "round5_map <- list(\n",
    "  'R4W1' = 'R5WX', 'R4X1' = 'R5WX',\n",
    "  'R4Y1' = 'R5YZ', 'R4Z1' = 'R5YZ'\n",
    ")\n",
    "\n",
    "round6_map <- list(\n",
    "  'R5WX' = 'R6CH',\n",
    "  'R5YZ' = 'R6CH'\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1dfbce95",
   "metadata": {
    "papermill": {
     "duration": 0.013535,
     "end_time": "2024-03-21T00:26:51.832086",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.818551",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Round 1 predictions"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "fa0e91fc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:51.910795Z",
     "iopub.status.busy": "2024-03-21T00:26:51.908117Z",
     "iopub.status.idle": "2024-03-21T00:26:52.214181Z",
     "shell.execute_reply": "2024-03-21T00:26:52.211379Z"
    },
    "papermill": {
     "duration": 0.326919,
     "end_time": "2024-03-21T00:26:52.217255",
     "exception": false,
     "start_time": "2024-03-21T00:26:51.890336",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Round 1 Predictions\n",
    "Rd1Df <- data.frame(Slot = character(), Team1 = character(), Team2 = character(), \n",
    "                    SeedNum_T1 = numeric(), SeedNum_T2 = numeric())\n",
    "for (key in names(initial_matchups)) {\n",
    "  slot <- substr(key, 3, 3)\n",
    "  teams <- initial_matchups[[key]]\n",
    "  SeedNum_T1 <- as.numeric(teams[1])\n",
    "  SeedNum_T2 <- as.numeric(teams[2])\n",
    "  team1 <- paste0(slot, teams[1])\n",
    "  team2 <- paste0(slot, teams[2])\n",
    "  row_df <- data.frame(Slot = key, Team1 = team1, Team2 = team2, \n",
    "                       SeedNum_T1 = SeedNum_T1,  SeedNum_T2 =  SeedNum_T2)\n",
    "  Rd1Df <- rbind(Rd1Df, row_df)\n",
    "}\n",
    "Rd1Df$Tournament = \"M\"\n",
    "\n",
    "Rd1_team1 <- Rd1Df %>% \n",
    "  left_join(MensSeeds, by = c(\"Tournament\", \"Team1\" = \"Seed\")) %>% \n",
    "  rename(Team1ID = TeamID)\n",
    "Rd1_team2 <- Rd1Df %>% \n",
    "  left_join(MensSeeds, by = c(\"Tournament\", \"Team2\" = \"Seed\")) %>% \n",
    "  rename(Team2ID = TeamID)\n",
    "\n",
    "Rd1_pred <- merge(Rd1_team1, Rd1_team2, \n",
    "                  by = c(\"Tournament\", \"Slot\", \"Team1\", \"Team2\",  \n",
    "                         \"SeedNum_T1\",  \"SeedNum_T2\"), all = TRUE)\n",
    "Rd1_data <- Rd1_pred %>% \n",
    "  left_join(Predictors_2024, by = c(\"Team1ID\" = \"TeamID\")) %>% \n",
    "  rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, \n",
    "         T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, \n",
    "         T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, \n",
    "         T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,\n",
    "         T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, \n",
    "         T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, \n",
    "         T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, T1Stl = Stl, T1Blk = Blk,\n",
    "         T1TO = TO, T1TurnRat = TurnRat, T1AsstRat = AsstRat, T1OppOReb = OppOReb, T1OppORebRat = OppORebRat, \n",
    "         T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,\n",
    "         T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)\n",
    "Rd1_data <- Rd1_data %>% \n",
    "  left_join(Predictors_2024, by = c(\"Team2ID\" = \"TeamID\")) %>% \n",
    "  rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against, \n",
    "         T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, \n",
    "         T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, \n",
    "         T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,\n",
    "         T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, \n",
    "         T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, \n",
    "         T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, T2Stl = Stl, T2Blk = Blk,\n",
    "         T2TO = TO, T2TurnRat = TurnRat, T2AsstRat = AsstRat, T2OppOReb = OppOReb, T2OppORebRat = OppORebRat, \n",
    "         T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,\n",
    "         T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)\n",
    "Rd1_data$ELO_diff <- Rd1_data$T1ELO - Rd1_data$T2ELO\n",
    "Rd1_data$Seed_diff <- Rd1_data$SeedNum_T1 - Rd1_data$SeedNum_T2\n",
    "Rd1_data$Win_pct_dif <- Rd1_data$T1Win_pct - Rd1_data$T2Win_pct\n",
    "Rd1_data$PTS_for <- Rd1_data$T1Pts_for - Rd1_data$T2Pts_for\n",
    "Rd1_data$PTS_against <- Rd1_data$T1Pts_against - Rd1_data$T2Pts_against\n",
    "Rd1_data$ThreePtShots_diff <- Rd1_data$T1ThreePtShots - Rd1_data$T2ThreePtShots\n",
    "Rd1_data$Reb_diff <- Rd1_data$T1Reb - Rd1_data$T2Reb\n",
    "Rd1_data$ORebRate_diff <- Rd1_data$T1ORebRat - Rd1_data$T2ORebRat\n",
    "Rd1_data$OppORebRate_diff <- Rd1_data$T1OppORebRat - Rd1_data$T2OppORebRat\n",
    "Rd1_data$Turn_diff = Rd1_data$T1TO - Rd1_data$T2TO\n",
    "Rd1_data$rawSOS_diff <- Rd1_data$T1rawSOS - Rd1_data$T2rawSOS\n",
    "Rd1_data$ELOSOS_diff <- Rd1_data$T1ELOSOS - Rd1_data$T2ELOSOS\n",
    "Rd1_data$Rank_diff <- Rd1_data$T1Rank - Rd1_data$T2Rank\n",
    "Rd1_data$Margin_diff <- Rd1_data$T1Pts_diff - Rd1_data$T2Pts_diff\n",
    "rd_1_dmatrix <- xgb.DMatrix(data = as.matrix(Rd1_data[, predictors]))\n",
    "predictions <- predict(final_model, newdata = rd_1_dmatrix)\n",
    "Rd1_pred$Team <- ifelse(predictions >= 0.5, Rd1_pred$Team1ID, Rd1_pred$Team2ID)\n",
    "Rd1_pred$Win <- ifelse(Rd1_pred$Team == Rd1_pred$Team1ID, Rd1_pred$Team1, Rd1_pred$Team2)\n",
    "Rd1_pred$Seed <- ifelse(Rd1_pred$Team == Rd1_pred$Team1ID, \n",
    "                        Rd1_pred$SeedNum_T1, Rd1_pred$SeedNum_T2)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "87709c09",
   "metadata": {
    "papermill": {
     "duration": 0.014814,
     "end_time": "2024-03-21T00:26:52.246853",
     "exception": false,
     "start_time": "2024-03-21T00:26:52.232039",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Function for repeating for the following rounds"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "dece28a9",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:52.279129Z",
     "iopub.status.busy": "2024-03-21T00:26:52.276862Z",
     "iopub.status.idle": "2024-03-21T00:26:52.302809Z",
     "shell.execute_reply": "2024-03-21T00:26:52.300173Z"
    },
    "papermill": {
     "duration": 0.046009,
     "end_time": "2024-03-21T00:26:52.306110",
     "exception": false,
     "start_time": "2024-03-21T00:26:52.260101",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Define round by round function\n",
    "Rd_by_rd <- function(rd1, map, Predictors_2024, features) {\n",
    "  unique_destinations <- unique(unlist(map))\n",
    "  new_pred <- data.frame(Tournament = \"M\",\n",
    "                         Slot = unique_destinations,\n",
    "                         Team1 = character(length(unique_destinations)),\n",
    "                         Team2 = character(length(unique_destinations)),\n",
    "                         Team1ID = integer(length(unique_destinations)),\n",
    "                         Team2ID = integer(length(unique_destinations)),\n",
    "                         SeedNum_T1 = numeric(length(unique_destinations)),\n",
    "                         SeedNum_T2 = numeric(length(unique_destinations)))\n",
    "  for (i in 1:nrow(rd1)) {\n",
    "    Slot <- rd1$Slot[i]\n",
    "    Dest <- map[[Slot]]\n",
    "    row_index <- which(new_pred$Slot == Dest)\n",
    "    if (nchar(as.character(new_pred[row_index, \"Team1\"])) != 3) {\n",
    "      # Data corresponds to Team1\n",
    "      new_pred[row_index, \"Team1\"] <- rd1$Win[i]\n",
    "      new_pred[row_index, \"Team1ID\"] <- rd1$Team[i]\n",
    "      new_pred[row_index, \"SeedNum_T1\"] <- rd1$Seed[i]\n",
    "    } else {\n",
    "      # Data corresponds to Team2\n",
    "      new_pred[row_index, \"Team2\"] <- rd1$Win[i]\n",
    "      new_pred[row_index, \"Team2ID\"] <- rd1$Team[i]\n",
    "      new_pred[row_index, \"SeedNum_T2\"] <- rd1$Seed[i]\n",
    "    }\n",
    "  }\n",
    "  #Add features\n",
    "  Rd1_data <- new_pred %>% \n",
    "    left_join(Predictors_2024, by = c(\"Team1ID\" = \"TeamID\")) %>% \n",
    "    rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, \n",
    "           T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, \n",
    "           T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, \n",
    "           T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,\n",
    "           T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, \n",
    "           T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, \n",
    "           T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, T1Stl = Stl, T1Blk = Blk,\n",
    "           T1TO = TO, T1TurnRat = TurnRat, T1AsstRat = AsstRat, T1OppOReb = OppOReb, T1OppORebRat = OppORebRat, \n",
    "           T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,\n",
    "           T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)\n",
    "  Rd1_data <- Rd1_data %>% \n",
    "    left_join(Predictors_2024, by = c(\"Team2ID\" = \"TeamID\")) %>% \n",
    "    rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against,\n",
    "           T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, \n",
    "           T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, \n",
    "           T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,\n",
    "           T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, \n",
    "           T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, \n",
    "           T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, T2Stl = Stl, T2Blk = Blk,\n",
    "           T2TO = TO, T2TurnRat = TurnRat, T2AsstRat = AsstRat, T2OppOReb = OppOReb, T2OppORebRat = OppORebRat, \n",
    "           T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,\n",
    "           T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)\n",
    "  Rd1_data$ELO_diff <- Rd1_data$T1ELO - Rd1_data$T2ELO\n",
    "  Rd1_data$Seed_diff <- Rd1_data$SeedNum_T1 - Rd1_data$SeedNum_T2\n",
    "  Rd1_data$Win_pct_dif <- Rd1_data$T1Win_pct - Rd1_data$T2Win_pct\n",
    "  Rd1_data$PTS_for <- Rd1_data$T1Pts_for - Rd1_data$T2Pts_for\n",
    "  Rd1_data$PTS_against <- Rd1_data$T1Pts_against - Rd1_data$T2Pts_against\n",
    "  Rd1_data$ThreePtShots_diff <- Rd1_data$T1ThreePtShots - Rd1_data$T2ThreePtShots\n",
    "  Rd1_data$Reb_diff <- Rd1_data$T1Reb - Rd1_data$T2Reb\n",
    "  Rd1_data$ORebRate_diff <- Rd1_data$T1ORebRat - Rd1_data$T2ORebRat\n",
    "  Rd1_data$OppORebRate_diff <- Rd1_data$T1OppORebRat - Rd1_data$T2OppORebRat\n",
    "  Rd1_data$Turn_diff = Rd1_data$T1TO - Rd1_data$T2TO\n",
    "  Rd1_data$rawSOS_diff <- Rd1_data$T1rawSOS - Rd1_data$T2rawSOS\n",
    "  Rd1_data$ELOSOS_diff <- Rd1_data$T1ELOSOS - Rd1_data$T2ELOSOS\n",
    "  Rd1_data$Rank_diff <- Rd1_data$T1Rank - Rd1_data$T2Rank\n",
    "  Rd1_data$Margin_diff <- Rd1_data$T1Pts_diff - Rd1_data$T2Pts_diff\n",
    "  \n",
    "  #Predictions\n",
    "  rd_1_dmatrix <- xgb.DMatrix(data = as.matrix(Rd1_data[, features]))\n",
    "  predictions <- predict(final_model, newdata = rd_1_dmatrix)\n",
    "  new_pred$Team <- ifelse(predictions >= 0.5, new_pred$Team1ID, new_pred$Team2ID)\n",
    "  new_pred$Win <- ifelse(new_pred$Team == new_pred$Team1ID, new_pred$Team1, new_pred$Team2)\n",
    "  new_pred$Seed <- ifelse(new_pred$Team == new_pred$Team1ID, \n",
    "                          new_pred$SeedNum_T1, new_pred$SeedNum_T2)\n",
    "  return(new_pred)\n",
    "}"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8dd53517",
   "metadata": {
    "papermill": {
     "duration": 0.013896,
     "end_time": "2024-03-21T00:26:52.334224",
     "exception": false,
     "start_time": "2024-03-21T00:26:52.320328",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Create bracket"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "28d5482f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:52.368013Z",
     "iopub.status.busy": "2024-03-21T00:26:52.365538Z",
     "iopub.status.idle": "2024-03-21T00:26:53.069987Z",
     "shell.execute_reply": "2024-03-21T00:26:53.067583Z"
    },
    "papermill": {
     "duration": 0.724677,
     "end_time": "2024-03-21T00:26:53.073143",
     "exception": false,
     "start_time": "2024-03-21T00:26:52.348466",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Rest of rounds\n",
    "Rd2_pred <- Rd_by_rd(Rd1_pred, round2_map, Predictors_2024, predictors)\n",
    "Rd3_pred <- Rd_by_rd(Rd2_pred, round3_map, Predictors_2024, predictors)\n",
    "Rd4_pred <- Rd_by_rd(Rd3_pred, round4_map, Predictors_2024, predictors)\n",
    "Rd5_pred <- Rd_by_rd(Rd4_pred, round5_map, Predictors_2024, predictors)\n",
    "Rd6_pred <- Rd_by_rd(Rd5_pred, round6_map, Predictors_2024, predictors)\n",
    "\n",
    "#Combine all data\n",
    "Rd12_pred <- rbind(Rd1_pred, Rd2_pred)\n",
    "Rd123_pred <- rbind(Rd12_pred, Rd3_pred)\n",
    "Rd1234_pred <- rbind(Rd123_pred, Rd4_pred)\n",
    "Rd12345_pred <- rbind(Rd1234_pred, Rd5_pred)\n",
    "All_pred <- rbind(Rd12345_pred, Rd6_pred) \n",
    "All_pred <- All_pred %>% left_join(MTeams, by = c(\"Team\" = \"TeamID\"))\n",
    "\n",
    "Final_names <- All_pred %>% \n",
    "  select(Tournament, Slot, Team = Win, TeamName)\n",
    "\n",
    "MFinalBracket <- All_pred %>%  \n",
    "  mutate(Bracket = 1) %>% \n",
    "  select(Tournament, Bracket, Slot, Team = Win)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d1a37cc5",
   "metadata": {
    "papermill": {
     "duration": 0.013816,
     "end_time": "2024-03-21T00:26:53.100518",
     "exception": false,
     "start_time": "2024-03-21T00:26:53.086702",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Print final bracket with names"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "918b23ef",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:53.134198Z",
     "iopub.status.busy": "2024-03-21T00:26:53.132002Z",
     "iopub.status.idle": "2024-03-21T00:26:53.157386Z",
     "shell.execute_reply": "2024-03-21T00:26:53.154290Z"
    },
    "papermill": {
     "duration": 0.045909,
     "end_time": "2024-03-21T00:26:53.160679",
     "exception": false,
     "start_time": "2024-03-21T00:26:53.114770",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "   Tournament Slot Team       TeamName\n",
      "1           M R1W1  W01    Connecticut\n",
      "2           M R1W2  W02        Iowa St\n",
      "3           M R1W3  W03       Illinois\n",
      "4           M R1W4  W04         Auburn\n",
      "5           M R1W5  W05   San Diego St\n",
      "6           M R1W6  W11       Duquesne\n",
      "7           M R1W7  W10          Drake\n",
      "8           M R1W8  W08    FL Atlantic\n",
      "9           M R1X1  X01 North Carolina\n",
      "10          M R1X2  X02        Arizona\n",
      "11          M R1X3  X03         Baylor\n",
      "12          M R1X4  X04        Alabama\n",
      "13          M R1X5  X05   St Mary's CA\n",
      "14          M R1X6  X11     New Mexico\n",
      "15          M R1X7  X10         Nevada\n",
      "16          M R1X8  X08 Mississippi St\n",
      "17          M R1Y1  Y01         Purdue\n",
      "18          M R1Y2  Y02      Tennessee\n",
      "19          M R1Y3  Y03      Creighton\n",
      "20          M R1Y4  Y04         Kansas\n",
      "21          M R1Y5  Y05        Gonzaga\n",
      "22          M R1Y6  Y06 South Carolina\n",
      "23          M R1Y7  Y10    Colorado St\n",
      "24          M R1Y8  Y09            TCU\n",
      "25          M R1Z1  Z01        Houston\n",
      "26          M R1Z2  Z02      Marquette\n",
      "27          M R1Z3  Z03       Kentucky\n",
      "28          M R1Z4  Z04           Duke\n",
      "29          M R1Z5  Z05      Wisconsin\n",
      "30          M R1Z6  Z06     Texas Tech\n",
      "31          M R1Z7  Z10       Boise St\n",
      "32          M R1Z8  Z09      Texas A&M\n",
      "33          M R2W1  W01    Connecticut\n",
      "34          M R2W2  W02        Iowa St\n",
      "35          M R2W3  W03       Illinois\n",
      "36          M R2W4  W04         Auburn\n",
      "37          M R2X1  X01 North Carolina\n",
      "38          M R2X2  X02        Arizona\n",
      "39          M R2X3  X11     New Mexico\n",
      "40          M R2X4  X05   St Mary's CA\n",
      "41          M R2Y1  Y01         Purdue\n",
      "42          M R2Y2  Y02      Tennessee\n",
      "43          M R2Y3  Y06 South Carolina\n",
      "44          M R2Y4  Y05        Gonzaga\n",
      "45          M R2Z1  Z01        Houston\n",
      "46          M R2Z2  Z10       Boise St\n",
      "47          M R2Z3  Z06     Texas Tech\n",
      "48          M R2Z4  Z05      Wisconsin\n",
      "49          M R3W1  W01    Connecticut\n",
      "50          M R3W2  W02        Iowa St\n",
      "51          M R3X1  X01 North Carolina\n",
      "52          M R3X2  X02        Arizona\n",
      "53          M R3Y1  Y01         Purdue\n",
      "54          M R3Y2  Y02      Tennessee\n",
      "55          M R3Z1  Z01        Houston\n",
      "56          M R3Z2  Z06     Texas Tech\n",
      "57          M R4W1  W01    Connecticut\n",
      "58          M R4X1  X02        Arizona\n",
      "59          M R4Y1  Y01         Purdue\n",
      "60          M R4Z1  Z01        Houston\n",
      "61          M R5WX  W01    Connecticut\n",
      "62          M R5YZ  Y01         Purdue\n",
      "63          M R6CH  Y01         Purdue\n"
     ]
    }
   ],
   "source": [
    "print(Final_names)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ed60ccc3",
   "metadata": {
    "papermill": {
     "duration": 0.014651,
     "end_time": "2024-03-21T00:26:53.190652",
     "exception": false,
     "start_time": "2024-03-21T00:26:53.176001",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# WOMENS DATA\n",
    "## Code to Make Women's ELO Rankings by Season\n",
    "Using an optimizing function, optimized the elo.run formula from elo database to optimize parameters K, location, score differential, and date"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "dd514989",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:26:53.228112Z",
     "iopub.status.busy": "2024-03-21T00:26:53.224328Z",
     "iopub.status.idle": "2024-03-21T00:34:09.974926Z",
     "shell.execute_reply": "2024-03-21T00:34:09.972795Z"
    },
    "papermill": {
     "duration": 436.773526,
     "end_time": "2024-03-21T00:34:09.979218",
     "exception": false,
     "start_time": "2024-03-21T00:26:53.205692",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<dl>\n",
       "\t<dt>$par</dt>\n",
       "\t\t<dd><style>\n",
       ".list-inline {list-style: none; margin:0; padding: 0}\n",
       ".list-inline>li {display: inline-block}\n",
       ".list-inline>li:not(:last-child)::after {content: \"\\00b7\"; padding: 0 .5ex}\n",
       "</style>\n",
       "<ol class=list-inline><li>0.289191021070883</li><li>-0.0117805283843028</li><li>5.18845255143982</li><li>0</li></ol>\n",
       "</dd>\n",
       "\t<dt>$value</dt>\n",
       "\t\t<dd>0.1672062198769</dd>\n",
       "\t<dt>$counts</dt>\n",
       "\t\t<dd><style>\n",
       ".dl-inline {width: auto; margin:0; padding: 0}\n",
       ".dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}\n",
       ".dl-inline>dt::after {content: \":\\0020\"; padding-right: .5ex}\n",
       ".dl-inline>dt:not(:first-of-type) {padding-left: .5ex}\n",
       "</style><dl class=dl-inline><dt>function</dt><dd>13</dd><dt>gradient</dt><dd>13</dd></dl>\n",
       "</dd>\n",
       "\t<dt>$convergence</dt>\n",
       "\t\t<dd>0</dd>\n",
       "\t<dt>$message</dt>\n",
       "\t\t<dd>'CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH'</dd>\n",
       "</dl>\n"
      ],
      "text/latex": [
       "\\begin{description}\n",
       "\\item[\\$par] \\begin{enumerate*}\n",
       "\\item 0.289191021070883\n",
       "\\item -0.0117805283843028\n",
       "\\item 5.18845255143982\n",
       "\\item 0\n",
       "\\end{enumerate*}\n",
       "\n",
       "\\item[\\$value] 0.1672062198769\n",
       "\\item[\\$counts] \\begin{description*}\n",
       "\\item[function] 13\n",
       "\\item[gradient] 13\n",
       "\\end{description*}\n",
       "\n",
       "\\item[\\$convergence] 0\n",
       "\\item[\\$message] 'CONVERGENCE: REL\\_REDUCTION\\_OF\\_F <= FACTR*EPSMCH'\n",
       "\\end{description}\n"
      ],
      "text/markdown": [
       "$par\n",
       ":   1. 0.289191021070883\n",
       "2. -0.0117805283843028\n",
       "3. 5.18845255143982\n",
       "4. 0\n",
       "\n",
       "\n",
       "\n",
       "$value\n",
       ":   0.1672062198769\n",
       "$counts\n",
       ":   function\n",
       ":   13gradient\n",
       ":   13\n",
       "\n",
       "\n",
       "$convergence\n",
       ":   0\n",
       "$message\n",
       ":   'CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH'\n",
       "\n",
       "\n"
      ],
      "text/plain": [
       "$par\n",
       "[1]  0.28919102 -0.01178053  5.18845255  0.00000000\n",
       "\n",
       "$value\n",
       "[1] 0.1672062\n",
       "\n",
       "$counts\n",
       "function gradient \n",
       "      13       13 \n",
       "\n",
       "$convergence\n",
       "[1] 0\n",
       "\n",
       "$message\n",
       "[1] \"CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH\"\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "#load libraries\n",
    "library(readr) # for reading in data\n",
    "library(dplyr) # for data cleaning\n",
    "library(tidyr)\n",
    "library(purrr) # for functional programming\n",
    "library(forcats) # for recoding factors\n",
    "library(limSolve) # for solving linear equations\n",
    "library(sqldf)\n",
    "library(XML)\n",
    "library(RCurl)\n",
    "library(elo)\n",
    "\n",
    "#Womens ELO Code\n",
    "WCompactResults <- read.csv(\"../input/march-machine-learning-mania-2024/WRegularSeasonCompactResults.csv\" )\n",
    "\n",
    "test <- function(params) {\n",
    "  K = params[1]\n",
    "  loc = params[2]\n",
    "  score = params[3]\n",
    "  date = params[4]\n",
    "  for (year in min(WCompactResults$Season):max(WCompactResults$Season)) {\n",
    "    results <- WCompactResults[which(WCompactResults$Season == year),]\n",
    "    #Remove rows with NA, NaN, or Inf in critical columns\n",
    "    results <- results[!is.na(results$WScore) & !is.na(results$LScore) \n",
    "                       & is.finite(results$WScore) & is.finite(results$LScore), ]\n",
    "    results <- results[is.finite(results$DayNum),]\n",
    "    #Add result col for scoring elo, 1 for win, 0.5 for ot win\n",
    "    results$result <- ifelse(results$NumOT > 0, 0.5, 1)\n",
    "    #results$result <- score(results$WScore, results$LScore)\n",
    "    \n",
    "    #Add score margin, half margin if overtime\n",
    "    results$Margin <- ifelse(results$NumOT >0, 0.5*(results$WScore - results$LScore),\n",
    "                             results$WScore - results$LScore)\n",
    "    #Cap off margin to exclude blowouts\n",
    "    margin_cap = 25\n",
    "    results$Margin <- pmin(results$Margin, margin_cap)\n",
    "    \n",
    "    #Add Location value, 1 for home win, -1 for away win, 0 for neutral\n",
    "    results$Loc <- ifelse(results$WLoc == \"H\", -1, \n",
    "                          ifelse(results$WLoc == \"A\", 1, 0)) * loc\n",
    "    \n",
    "    #Reverse Day Num so regressed for earlier games\n",
    "    results$ReverseDayNum <- (max(results$DayNum) + 1) - results$DayNum \n",
    "    \n",
    "    \n",
    "    #Confirm data is clean\n",
    "    results <- results[is.finite(results$Loc) & is.finite(results$DayNum),]\n",
    "    \n",
    "    #Create the elo model\n",
    "    elo_model <- elo.run(data = results, \n",
    "                         formula = result ~ \n",
    "                           adjust(as.character(WTeamID), Loc)\n",
    "                         + as.character(LTeamID) + \n",
    "                           regress(ReverseDayNum, 1500, date), \n",
    "                         k = (K + (results$Margin*score)) )\n",
    "    \n",
    "    #Expand elo model to data frame\n",
    "    elo_results <- elo_model %>%\n",
    "      as.data.frame()\n",
    "    #Combine results data with elo data\n",
    "    results2 <- cbind(results, elo_results)\n",
    "    \n",
    "    \n",
    "    #Test on 2nd half of season\n",
    "    mid_date <- median(results$DayNum)\n",
    "    test_model <- results[\n",
    "      which(results$DayNum > mid_date),]\n",
    "    results3 <- merge(x = results2, y = test_model[c(\"Season\", \"DayNum\",\n",
    "                                                         \"WTeamID\",\"LTeamID\")], \n",
    "                      by = c(\"Season\", \"DayNum\",\"WTeamID\", \"LTeamID\"), all.y = TRUE)\n",
    "    \n",
    "    #Final elos function, add year and team id\n",
    "    final_elos <- as.data.frame(final.elos(elo_model))\n",
    "    names(final_elos)[1] <- \"ELO\"\n",
    "    final_elos$Season <- year\n",
    "    final_elos$TeamID <- row.names(final_elos)\n",
    "    final_elos$TeamID <- as.integer(row.names(final_elos))\n",
    "    \n",
    "    \n",
    "    #If first year, create final elo dataframe otherwise add final elo for every year\n",
    "    ifelse(year == min(WCompactResults$Season), final_elo <- final_elos, \n",
    "           final_elo <- rbind(final_elo, final_elos))\n",
    "    #If first year, create all games dataframe, otherwise add results2 for every year\n",
    "    ifelse(year == min(WCompactResults$Season), all_games <- results2, \n",
    "           all_games <- rbind(all_games, results2))\n",
    "  }\n",
    "  final_elo <<- final_elo\n",
    "  all_games <<- na.omit(all_games)\n",
    "  results3$error <- (results3$result - results3$p.A)^2\n",
    "  errorVal <- sum(results3$error)/nrow(results3)\n",
    "  \n",
    "  #Confirm data is finite\n",
    "  if (!is.finite(errorVal)) {\n",
    "    warning(\"Non-finite value encountered. Returning a large number instead.\")\n",
    "    return(1e6)  # Return a large but finite value to indicate a poor fit\n",
    "  }\n",
    "  return(errorVal)\n",
    "}\n",
    "\n",
    "optim(par=c(0,0,0,0), fn=test, \n",
    "      lower = c(0,-Inf,-Inf,0), upper = c(Inf,Inf,Inf,1), method=\"L-BFGS-B\")\n",
    "\n",
    "FinalElo_W <- final_elo %>%\n",
    "  group_by(Season) %>%\n",
    "  arrange(Season, desc(ELO)) %>%\n",
    "  mutate(Rank = dense_rank(desc(ELO))) %>%\n",
    "  ungroup()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7a0e81b3",
   "metadata": {
    "papermill": {
     "duration": 0.018327,
     "end_time": "2024-03-21T00:34:10.019745",
     "exception": false,
     "start_time": "2024-03-21T00:34:10.001418",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Example ELO\n",
    "ELO sorted for 2024"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "339aaf5c",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:10.056440Z",
     "iopub.status.busy": "2024-03-21T00:34:10.054522Z",
     "iopub.status.idle": "2024-03-21T00:34:10.154442Z",
     "shell.execute_reply": "2024-03-21T00:34:10.151866Z"
    },
    "papermill": {
     "duration": 0.123587,
     "end_time": "2024-03-21T00:34:10.157376",
     "exception": false,
     "start_time": "2024-03-21T00:34:10.033789",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A data.frame: 25 × 5</caption>\n",
       "<thead>\n",
       "\t<tr><th></th><th scope=col>TeamID</th><th scope=col>ELO</th><th scope=col>Season</th><th scope=col>Rank</th><th scope=col>TeamName</th></tr>\n",
       "\t<tr><th></th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;int&gt;</th><th scope=col>&lt;chr&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><th scope=row>1</th><td>3376</td><td>2187.830</td><td>2024</td><td> 1</td><td>South Carolina</td></tr>\n",
       "\t<tr><th scope=row>2</th><td>3163</td><td>2110.041</td><td>2024</td><td> 2</td><td>Connecticut   </td></tr>\n",
       "\t<tr><th scope=row>3</th><td>3400</td><td>2105.843</td><td>2024</td><td> 3</td><td>Texas         </td></tr>\n",
       "\t<tr><th scope=row>4</th><td>3261</td><td>2086.060</td><td>2024</td><td> 4</td><td>LSU           </td></tr>\n",
       "\t<tr><th scope=row>5</th><td>3234</td><td>2067.443</td><td>2024</td><td> 5</td><td>Iowa          </td></tr>\n",
       "\t<tr><th scope=row>6</th><td>3323</td><td>2038.057</td><td>2024</td><td> 6</td><td>Notre Dame    </td></tr>\n",
       "\t<tr><th scope=row>7</th><td>3211</td><td>1993.457</td><td>2024</td><td> 7</td><td>Gonzaga       </td></tr>\n",
       "\t<tr><th scope=row>8</th><td>3417</td><td>1967.530</td><td>2024</td><td> 8</td><td>UCLA          </td></tr>\n",
       "\t<tr><th scope=row>9</th><td>3425</td><td>1964.967</td><td>2024</td><td> 9</td><td>USC           </td></tr>\n",
       "\t<tr><th scope=row>10</th><td>3390</td><td>1960.039</td><td>2024</td><td>10</td><td>Stanford      </td></tr>\n",
       "\t<tr><th scope=row>11</th><td>3292</td><td>1942.415</td><td>2024</td><td>11</td><td>MTSU          </td></tr>\n",
       "\t<tr><th scope=row>12</th><td>3424</td><td>1928.644</td><td>2024</td><td>12</td><td>UNLV          </td></tr>\n",
       "\t<tr><th scope=row>13</th><td>3301</td><td>1928.099</td><td>2024</td><td>13</td><td>NC State      </td></tr>\n",
       "\t<tr><th scope=row>14</th><td>3343</td><td>1913.437</td><td>2024</td><td>14</td><td>Princeton     </td></tr>\n",
       "\t<tr><th scope=row>15</th><td>3333</td><td>1906.409</td><td>2024</td><td>15</td><td>Oregon St     </td></tr>\n",
       "\t<tr><th scope=row>16</th><td>3452</td><td>1900.705</td><td>2024</td><td>16</td><td>West Virginia </td></tr>\n",
       "\t<tr><th scope=row>17</th><td>3453</td><td>1899.444</td><td>2024</td><td>17</td><td>WI Green Bay  </td></tr>\n",
       "\t<tr><th scope=row>18</th><td>3243</td><td>1895.170</td><td>2024</td><td>18</td><td>Kansas St     </td></tr>\n",
       "\t<tr><th scope=row>19</th><td>3397</td><td>1894.159</td><td>2024</td><td>19</td><td>Tennessee     </td></tr>\n",
       "\t<tr><th scope=row>20</th><td>3195</td><td>1893.752</td><td>2024</td><td>20</td><td>FL Gulf Coast </td></tr>\n",
       "\t<tr><th scope=row>21</th><td>3326</td><td>1891.393</td><td>2024</td><td>21</td><td>Ohio St       </td></tr>\n",
       "\t<tr><th scope=row>22</th><td>3193</td><td>1885.845</td><td>2024</td><td>22</td><td>Fairfield     </td></tr>\n",
       "\t<tr><th scope=row>23</th><td>3350</td><td>1885.257</td><td>2024</td><td>23</td><td>Richmond      </td></tr>\n",
       "\t<tr><th scope=row>24</th><td>3181</td><td>1884.830</td><td>2024</td><td>24</td><td>Duke          </td></tr>\n",
       "\t<tr><th scope=row>25</th><td>3124</td><td>1874.971</td><td>2024</td><td>25</td><td>Baylor        </td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A data.frame: 25 × 5\n",
       "\\begin{tabular}{r|lllll}\n",
       "  & TeamID & ELO & Season & Rank & TeamName\\\\\n",
       "  & <int> & <dbl> & <int> & <int> & <chr>\\\\\n",
       "\\hline\n",
       "\t1 & 3376 & 2187.830 & 2024 &  1 & South Carolina\\\\\n",
       "\t2 & 3163 & 2110.041 & 2024 &  2 & Connecticut   \\\\\n",
       "\t3 & 3400 & 2105.843 & 2024 &  3 & Texas         \\\\\n",
       "\t4 & 3261 & 2086.060 & 2024 &  4 & LSU           \\\\\n",
       "\t5 & 3234 & 2067.443 & 2024 &  5 & Iowa          \\\\\n",
       "\t6 & 3323 & 2038.057 & 2024 &  6 & Notre Dame    \\\\\n",
       "\t7 & 3211 & 1993.457 & 2024 &  7 & Gonzaga       \\\\\n",
       "\t8 & 3417 & 1967.530 & 2024 &  8 & UCLA          \\\\\n",
       "\t9 & 3425 & 1964.967 & 2024 &  9 & USC           \\\\\n",
       "\t10 & 3390 & 1960.039 & 2024 & 10 & Stanford      \\\\\n",
       "\t11 & 3292 & 1942.415 & 2024 & 11 & MTSU          \\\\\n",
       "\t12 & 3424 & 1928.644 & 2024 & 12 & UNLV          \\\\\n",
       "\t13 & 3301 & 1928.099 & 2024 & 13 & NC State      \\\\\n",
       "\t14 & 3343 & 1913.437 & 2024 & 14 & Princeton     \\\\\n",
       "\t15 & 3333 & 1906.409 & 2024 & 15 & Oregon St     \\\\\n",
       "\t16 & 3452 & 1900.705 & 2024 & 16 & West Virginia \\\\\n",
       "\t17 & 3453 & 1899.444 & 2024 & 17 & WI Green Bay  \\\\\n",
       "\t18 & 3243 & 1895.170 & 2024 & 18 & Kansas St     \\\\\n",
       "\t19 & 3397 & 1894.159 & 2024 & 19 & Tennessee     \\\\\n",
       "\t20 & 3195 & 1893.752 & 2024 & 20 & FL Gulf Coast \\\\\n",
       "\t21 & 3326 & 1891.393 & 2024 & 21 & Ohio St       \\\\\n",
       "\t22 & 3193 & 1885.845 & 2024 & 22 & Fairfield     \\\\\n",
       "\t23 & 3350 & 1885.257 & 2024 & 23 & Richmond      \\\\\n",
       "\t24 & 3181 & 1884.830 & 2024 & 24 & Duke          \\\\\n",
       "\t25 & 3124 & 1874.971 & 2024 & 25 & Baylor        \\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A data.frame: 25 × 5\n",
       "\n",
       "| <!--/--> | TeamID &lt;int&gt; | ELO &lt;dbl&gt; | Season &lt;int&gt; | Rank &lt;int&gt; | TeamName &lt;chr&gt; |\n",
       "|---|---|---|---|---|---|\n",
       "| 1 | 3376 | 2187.830 | 2024 |  1 | South Carolina |\n",
       "| 2 | 3163 | 2110.041 | 2024 |  2 | Connecticut    |\n",
       "| 3 | 3400 | 2105.843 | 2024 |  3 | Texas          |\n",
       "| 4 | 3261 | 2086.060 | 2024 |  4 | LSU            |\n",
       "| 5 | 3234 | 2067.443 | 2024 |  5 | Iowa           |\n",
       "| 6 | 3323 | 2038.057 | 2024 |  6 | Notre Dame     |\n",
       "| 7 | 3211 | 1993.457 | 2024 |  7 | Gonzaga        |\n",
       "| 8 | 3417 | 1967.530 | 2024 |  8 | UCLA           |\n",
       "| 9 | 3425 | 1964.967 | 2024 |  9 | USC            |\n",
       "| 10 | 3390 | 1960.039 | 2024 | 10 | Stanford       |\n",
       "| 11 | 3292 | 1942.415 | 2024 | 11 | MTSU           |\n",
       "| 12 | 3424 | 1928.644 | 2024 | 12 | UNLV           |\n",
       "| 13 | 3301 | 1928.099 | 2024 | 13 | NC State       |\n",
       "| 14 | 3343 | 1913.437 | 2024 | 14 | Princeton      |\n",
       "| 15 | 3333 | 1906.409 | 2024 | 15 | Oregon St      |\n",
       "| 16 | 3452 | 1900.705 | 2024 | 16 | West Virginia  |\n",
       "| 17 | 3453 | 1899.444 | 2024 | 17 | WI Green Bay   |\n",
       "| 18 | 3243 | 1895.170 | 2024 | 18 | Kansas St      |\n",
       "| 19 | 3397 | 1894.159 | 2024 | 19 | Tennessee      |\n",
       "| 20 | 3195 | 1893.752 | 2024 | 20 | FL Gulf Coast  |\n",
       "| 21 | 3326 | 1891.393 | 2024 | 21 | Ohio St        |\n",
       "| 22 | 3193 | 1885.845 | 2024 | 22 | Fairfield      |\n",
       "| 23 | 3350 | 1885.257 | 2024 | 23 | Richmond       |\n",
       "| 24 | 3181 | 1884.830 | 2024 | 24 | Duke           |\n",
       "| 25 | 3124 | 1874.971 | 2024 | 25 | Baylor         |\n",
       "\n"
      ],
      "text/plain": [
       "   TeamID ELO      Season Rank TeamName      \n",
       "1  3376   2187.830 2024    1   South Carolina\n",
       "2  3163   2110.041 2024    2   Connecticut   \n",
       "3  3400   2105.843 2024    3   Texas         \n",
       "4  3261   2086.060 2024    4   LSU           \n",
       "5  3234   2067.443 2024    5   Iowa          \n",
       "6  3323   2038.057 2024    6   Notre Dame    \n",
       "7  3211   1993.457 2024    7   Gonzaga       \n",
       "8  3417   1967.530 2024    8   UCLA          \n",
       "9  3425   1964.967 2024    9   USC           \n",
       "10 3390   1960.039 2024   10   Stanford      \n",
       "11 3292   1942.415 2024   11   MTSU          \n",
       "12 3424   1928.644 2024   12   UNLV          \n",
       "13 3301   1928.099 2024   13   NC State      \n",
       "14 3343   1913.437 2024   14   Princeton     \n",
       "15 3333   1906.409 2024   15   Oregon St     \n",
       "16 3452   1900.705 2024   16   West Virginia \n",
       "17 3453   1899.444 2024   17   WI Green Bay  \n",
       "18 3243   1895.170 2024   18   Kansas St     \n",
       "19 3397   1894.159 2024   19   Tennessee     \n",
       "20 3195   1893.752 2024   20   FL Gulf Coast \n",
       "21 3326   1891.393 2024   21   Ohio St       \n",
       "22 3193   1885.845 2024   22   Fairfield     \n",
       "23 3350   1885.257 2024   23   Richmond      \n",
       "24 3181   1884.830 2024   24   Duke          \n",
       "25 3124   1874.971 2024   25   Baylor        "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "WTeams <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/WTeams.csv\" , sep = ',')\n",
    "elo_2024 <- FinalElo_W %>% filter(Season == 2024)\n",
    "Final_elo_2024 <- merge(elo_2024, WTeams[, c(\"TeamID\", \"TeamName\")], \n",
    "                        by.x = \"TeamID\", by.y = \"TeamID\", all.x = TRUE)\n",
    "sorted_final_elo_2024 <- Final_elo_2024 %>% \n",
    "  arrange(desc(ELO)) %>%\n",
    "  mutate(Rank = row_number())\n",
    "head(sorted_final_elo_2024, 25)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "280f1a0e",
   "metadata": {
    "papermill": {
     "duration": 0.014635,
     "end_time": "2024-03-21T00:34:10.186507",
     "exception": false,
     "start_time": "2024-03-21T00:34:10.171872",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Creating Metrics\n",
    "### Using the compact and detailed regular season results, create 2 dataframes of metrics sorted by team and season\n",
    "Simple metrics based on compact results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "371dc3d2",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:10.219382Z",
     "iopub.status.busy": "2024-03-21T00:34:10.217492Z",
     "iopub.status.idle": "2024-03-21T00:34:18.982670Z",
     "shell.execute_reply": "2024-03-21T00:34:18.980436Z"
    },
    "papermill": {
     "duration": 8.786031,
     "end_time": "2024-03-21T00:34:18.986570",
     "exception": false,
     "start_time": "2024-03-21T00:34:10.200539",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Load libraries\n",
    "library(readr) # for reading in data\n",
    "library(tidyr)\n",
    "library(dplyr) # for data cleaning\n",
    "library(purrr) # for functional programming\n",
    "library(forcats) # for recoding factors\n",
    "library(limSolve) # for solving linear equations\n",
    "\n",
    "WCompactResults <- read.csv(\"../input/march-machine-learning-mania-2024/WRegularSeasonCompactResults.csv\" )\n",
    "WDetailedResults <- read.csv(\"../input/march-machine-learning-mania-2024/WRegularSeasonDetailedResults.csv\" )\n",
    "WCompactResults <- WCompactResults %>% filter(Season >= min(WDetailedResults$Season))\n",
    "\n",
    "#Womens Basic Metrics\n",
    "WELO <- FinalElo_W\n",
    "\n",
    "suppressMessages(\n",
    "for (year in min(WCompactResults$Season):max(WCompactResults$Season)) {\n",
    "  data <- WCompactResults[which(WCompactResults$Season == year),]\n",
    "  elo_season <- WELO[which(WELO$Season == year),]\n",
    "  #Data when winning\n",
    "  wins_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WPts_for = sum(WScore), WPts_against = sum(LScore), \n",
    "              WPts_diff = mean(WScore - LScore), Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #Data when losing\n",
    "  loss_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LPts_for = sum(LScore), LPts_against = sum(WScore), \n",
    "              LPts_diff = mean(LScore - WScore), Losses = n(),\n",
    "              LBlowouts = sum((WScore-LScore) >= 25 ),\n",
    "              LClose = sum((WScore-LScore) <= 5 )) %>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and clean\n",
    "  results <- merge(wins_df, loss_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  results$Wins[is.na(results$Wins)] <- 0\n",
    "  results$Losses[is.na(results$Losses)] <- 0\n",
    "  #Create winning percentage, points for, and points against cols\n",
    "  results <- results %>% \n",
    "    group_by(TeamID, Season) %>% \n",
    "    mutate(Games = Wins+Losses, \n",
    "           Win_pct = Wins/(Wins+Losses), \n",
    "           Pts_for = (WPts_for+LPts_for)/(Wins+Losses), \n",
    "           Pts_against = (WPts_against+LPts_against)/(Wins+Losses),\n",
    "           Pts_diff = (WPts_diff*Wins+LPts_diff*Losses)/(Wins+Losses)) %>% \n",
    "    select(Season, TeamID, Games, Win_pct, Pts_for, Pts_against, Pts_diff, LBlowouts, LClose)\n",
    "  #Raw SOS (based on opponent winning percentage)\n",
    "  raw_sosW <- data %>%\n",
    "    left_join(results, by  = c(\"LTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WSOS = mean(Win_pct), WNum = n()) %>% \n",
    "    rename(TeamID = WTeamID)\n",
    "  raw_sosL <- data %>%\n",
    "    left_join(results, by  = c(\"WTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LSOS = mean(Win_pct), LNum = n()) %>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  raw_sos <- merge(raw_sosW, raw_sosL, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  raw_sos$WSOS[is.na(raw_sos$WSOS)] <- 0\n",
    "  raw_sos$LSOS[is.na(raw_sos$LSOS)] <- 0\n",
    "  raw_sos$WNum[is.na(raw_sos$WNum)] <- 0\n",
    "  raw_sos$LNum[is.na(raw_sos$LNum)] <- 0\n",
    "  raw_sos <- raw_sos %>% \n",
    "    mutate(rawSOS = ((WSOS*WNum)+(LSOS*LNum))/(WNum+LNum))\n",
    "  #ELO SOS (based on opponent elo from prior calculations)\n",
    "  elo_sosW <- data %>%\n",
    "    left_join(elo_season, by  = c(\"LTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WELOSOS = mean(ELO), WNum = n()) %>% \n",
    "    rename(TeamID = WTeamID)\n",
    "  elo_sosL <- data %>%\n",
    "    left_join(elo_season, by  = c(\"WTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LELOSOS = mean(ELO), LNum = n()) %>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  elo_sos <- merge(elo_sosW, elo_sosL, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  elo_sos$WELOSOS[is.na(elo_sos$WELOSOS)] <- 0\n",
    "  elo_sos$LELOSOS[is.na(elo_sos$LELOSOS)] <- 0\n",
    "  elo_sos$WNum[is.na(elo_sos$WNum)] <- 0\n",
    "  elo_sos$LNum[is.na(elo_sos$LNum)] <- 0\n",
    "  elo_sos <- elo_sos %>% \n",
    "    mutate(ELOSOS = ((WELOSOS*WNum)+(LELOSOS*LNum))/(WNum+LNum))\n",
    "  #All SOS data\n",
    "  SOS <- merge(elo_sos, raw_sos, by = c(\"TeamID\", \"Season\"), all = TRUE) %>%\n",
    "    select(Season, TeamID, rawSOS, ELOSOS)\n",
    "  \n",
    "   #Wins vs top 50 teams\n",
    "  WOppElo <- data %>% \n",
    "    left_join(WELO, by = c(\"LTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(WTeamID, Season) %>% \n",
    "    rename(LRank = Rank) %>% \n",
    "    filter(LRank <= 50) %>% \n",
    "    summarize(Quad1W = n()) %>% \n",
    "    rename(TeamID = WTeamID)\n",
    "  #Loss vs top 50 teams\n",
    "  LOppElo <- data %>% \n",
    "    left_join(WELO, by = c(\"WTeamID\" = \"TeamID\", \"Season\")) %>%\n",
    "    group_by(LTeamID, Season) %>% \n",
    "    rename(WRank = Rank) %>% \n",
    "    filter(WRank <= 50) %>% \n",
    "    summarize(Quad1L = n())%>% \n",
    "    rename(TeamID = LTeamID)\n",
    "  #Record vs top 50 teams\n",
    "  OppElo <- merge(WOppElo, LOppElo, by = c(\"TeamID\", \"Season\"), all = TRUE) %>%\n",
    "    mutate(Quad1Rec = Quad1W/(Quad1W + Quad1L), Quad1Games = (Quad1W + Quad1L)) %>%\n",
    "    mutate(Quad1Rec = replace_na(Quad1Rec, 0), Quad1Games = replace_na(Quad1Games, 0)) %>% \n",
    "    select(Season, TeamID, Quad1Rec, Quad1Games)\n",
    "  \n",
    "  #Merge with SOS\n",
    "  SOS_Q1 <- SOS %>% left_join(OppElo, by = c(\"Season\", \"TeamID\"))\n",
    "  #All simple team metrics\n",
    "  results <- results %>% \n",
    "    left_join(SOS_Q1, by = c(\"Season\", \"TeamID\"))\n",
    "  #If first year, create final table, otherwise add data\n",
    "  ifelse(year == min(WCompactResults$Season), WSimpleMetrics <- results, \n",
    "         WSimpleMetrics <- rbind(WSimpleMetrics, results))\n",
    "})\n",
    "SimpleMetrics_W <- WSimpleMetrics"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "11e981f6",
   "metadata": {
    "papermill": {
     "duration": 0.014289,
     "end_time": "2024-03-21T00:34:19.016112",
     "exception": false,
     "start_time": "2024-03-21T00:34:19.001823",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "Detailed metrics based on detailed results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "fa72e514",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:19.048945Z",
     "iopub.status.busy": "2024-03-21T00:34:19.047058Z",
     "iopub.status.idle": "2024-03-21T00:34:29.679142Z",
     "shell.execute_reply": "2024-03-21T00:34:29.677025Z"
    },
    "papermill": {
     "duration": 10.651564,
     "end_time": "2024-03-21T00:34:29.681675",
     "exception": false,
     "start_time": "2024-03-21T00:34:19.030111",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Womens Detailed Metrics\n",
    "suppressMessages(\n",
    "for (year in min(WDetailedResults$Season):max(WDetailedResults$Season)) {\n",
    "  data <- WDetailedResults[which(WDetailedResults$Season == year),]\n",
    "  #fg pct, 3pt pct, #3pt att/total att, ft att\n",
    "  #In wins\n",
    "  Wfg_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WFgPct = (sum(WFGM))/(sum(WFGA)), \n",
    "              W3PtPct = (sum(WFGM3))/(sum(WFGA3)), \n",
    "              W3PtShots = (sum(WFGA3))/(sum(WFGA)), \n",
    "              WFtPct = (sum(WFTM))/(sum(WFTA)),\n",
    "              WFtA = (sum(WFTA)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #In losses \n",
    "  Lfg_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LFgPct = (sum(LFGM))/(sum(LFGA)), \n",
    "              L3PtPct = (sum(LFGM3))/(sum(LFGA3)), \n",
    "              L3PtShots = (sum(LFGA3))/(sum(LFGA)), \n",
    "              LFtPct = (sum(LFTM))/(sum(LFTA)),\n",
    "              LFtA = (sum(LFTA)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  fg_df <- merge(Wfg_df, Lfg_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  fg_df$Wins[is.na(fg_df$Wins)] <- 0\n",
    "  fg_df$Losses[is.na(fg_df$Losses)] <- 0\n",
    "  fg_df <- fg_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(FgPct = (WFgPct*Wins+LFgPct*Losses)/(Wins+Losses), \n",
    "           ThreePtPct = (W3PtPct*Wins+L3PtPct*Losses)/(Wins+Losses),\n",
    "           ThreePtShots = (W3PtShots*Wins+L3PtShots*Losses)/(Wins+Losses),\n",
    "           FtPct = (WFtPct*Wins+LFtPct*Losses)/(Wins+Losses),\n",
    "           FtA = (WFtA*Wins+LFtA*Losses)/(Wins+Losses),\n",
    "           Games = (Wins + Losses))\n",
    "  #opp in wins\n",
    "  OppWfg_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(OppWFgPct = (sum(LFGM))/(sum(LFGA)), \n",
    "              OppW3PtPct = (sum(LFGM3))/(sum(LFGA3)), \n",
    "              OppW3PtShots = (sum(LFGA3))/(sum(LFGA)),\n",
    "              OppWFtA = (sum(LFTA)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #opp in losses\n",
    "  OppLfg_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(OppLFgPct = (sum(WFGM))/(sum(WFGA)), \n",
    "              OppL3PtPct = (sum(WFGM3))/(sum(WFGA3)), \n",
    "              OppL3PtShots = (sum(WFGA3))/(sum(WFGA)), \n",
    "              OppLFtA = (sum(WFTA)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  opp_fg_df <- merge(OppWfg_df, OppLfg_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  opp_fg_df$Wins[is.na(opp_fg_df$Wins)] <- 0\n",
    "  opp_fg_df$Losses[is.na(opp_fg_df$Losses)] <- 0\n",
    "  opp_fg_df <- opp_fg_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(OppFgPct = (OppWFgPct*Wins+OppLFgPct*Losses)/(Wins+Losses), \n",
    "           OppThreePtPct = (OppW3PtPct*Wins+OppL3PtPct*Losses)/(Wins+Losses),\n",
    "           OppThreePtShots = (OppW3PtShots*Wins+OppL3PtShots*Losses)/(Wins+Losses),\n",
    "           OppFtA = (OppWFtA*Wins+OppLFtA*Losses)/(Wins+Losses)) %>%\n",
    "    select(-Wins, -Losses)\n",
    "  fg_results <-  merge(fg_df, opp_fg_df, by = c(\"TeamID\", \"Season\"), all = TRUE) %>% \n",
    "    select(Season, TeamID, FgPct, ThreePtPct, ThreePtShots, FtPct, FtA,\n",
    "           OppFgPct, OppThreePtPct, OppThreePtShots, OppFtA, Wins, Losses, Games)\n",
    "  #reb, oreb/opponent reb, blocks + steals, turnovers, asst/to\n",
    "  #Win stats\n",
    "  Wdef_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(WReb = (sum(WOR + WDR)/n()), \n",
    "              WOReb = sum(WOR)/n(),\n",
    "              WORebRat = (sum(WOR/LDR)/n()),\n",
    "              WBlkStl = (sum(WBlk+WStl)/n()), \n",
    "              WTurn = (sum(WTO)/n()), \n",
    "              WAsstRat = (sum(WAst/WTO)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #Loss stats\n",
    "  Ldef_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(LReb = (sum(LOR + LDR)/n()), \n",
    "              LOReb = sum(LOR)/n(),\n",
    "              LORebRat = (sum(LOR/(LOR +WDR))/n()),\n",
    "              LBlkStl = (sum(LBlk+LStl)/n()), \n",
    "              LTurn = (sum(LTO)/n()), \n",
    "              LAsstRat = (sum(LAst/LTO)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  def_df <- merge(Wdef_df, Ldef_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  def_df$Wins[is.na(def_df$Wins)] <- 0\n",
    "  def_df$Losses[is.na(def_df$Losses)] <- 0\n",
    "  def_df <- def_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(Reb = (WReb*Wins+LReb*Losses)/(Wins+Losses),\n",
    "           OReb = (WOReb*Wins+LOReb*Losses)/(Wins+Losses),\n",
    "           ORebRat = (WORebRat*Wins+LORebRat*Losses)/(Wins+Losses),\n",
    "           BlkStl = (WBlkStl*Wins+ LBlkStl*Losses)/(Wins+Losses),\n",
    "           TO = (WTurn*Wins+ LTurn*Losses)/(Wins+Losses),\n",
    "           AsstRat = (WAsstRat*Wins+ LAsstRat*Losses)/(Wins+Losses),\n",
    "           Games = (Wins + Losses))\n",
    "  #opp in wins \n",
    "  OppWdef_df <- data %>% \n",
    "    group_by(WTeamID, Season) %>% \n",
    "    summarize(OppWReb = (sum(LOR + LDR)/n()), \n",
    "              OppWORebRat = (sum(LOR/WDR)/n()),\n",
    "              OppWBlkStl = (sum(LBlk+LStl)/n()), \n",
    "              OppWAsstRat = (sum(LAst/LTO)/n()),\n",
    "              Wins = n()) %>%\n",
    "    rename(TeamID = WTeamID)\n",
    "  #opp in losses\n",
    "  OppLdef_df <- data %>% \n",
    "    group_by(LTeamID, Season) %>% \n",
    "    summarize(OppLReb = (sum(WOR + WDR)/n()), \n",
    "              OppLORebRat = (sum(WOR/LDR)/n()),\n",
    "              OppLBlkStl = (sum(WBlk+WStl)/n()), \n",
    "              OppLAsstRat = (sum(WAst/WTO)/n()),\n",
    "              Losses = n()) %>%\n",
    "    rename(TeamID = LTeamID)\n",
    "  #Merge and summarize\n",
    "  opp_def_df <- merge(OppWdef_df, OppLdef_df, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  opp_def_df$Wins[is.na(opp_def_df$Wins)] <- 0\n",
    "  opp_def_df$Losses[is.na(opp_def_df$Losses)] <- 0\n",
    "  opp_def_df <- opp_def_df %>% \n",
    "    group_by(TeamID, Season) %>%\n",
    "    mutate(OppReb = (OppWReb*Wins+OppLReb*Losses)/(Wins+Losses),\n",
    "           OppORebRat = (OppWORebRat*Wins+OppLORebRat*Losses)/(Wins+Losses),\n",
    "           OppBlkStl = (OppWBlkStl*Wins+ OppLBlkStl*Losses)/(Wins+Losses),\n",
    "           OppAsstRat = (OppWAsstRat*Wins+ OppLAsstRat*Losses)/(Wins+Losses)) %>% \n",
    "    select(-Wins, -Losses)\n",
    "  def_results <-  merge(def_df, opp_def_df, by = c(\"TeamID\", \"Season\"), all = TRUE) %>%\n",
    "    select(Season, TeamID, Reb, OReb, ORebRat, BlkStl, TO, AsstRat, \n",
    "           OppReb, OppORebRat, OppBlkStl, OppAsstRat)\n",
    "  #Merge fg and def dataframes\n",
    "  results <- merge(fg_results, def_results, by = c(\"TeamID\", \"Season\"), all = TRUE)\n",
    "  #If first year, create final table, otherwise add data\n",
    "  ifelse(year == min(WCompactResults$Season), WDetailedMetrics <- results, \n",
    "         WDetailedMetrics <- rbind(WDetailedMetrics, results))\n",
    "})\n",
    "DetailedMetrics_W <- WDetailedMetrics"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7c28a7bc",
   "metadata": {
    "papermill": {
     "duration": 0.014531,
     "end_time": "2024-03-21T00:34:29.710976",
     "exception": false,
     "start_time": "2024-03-21T00:34:29.696445",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Predictors\n",
    "Merge all dataframes (elo, simple metrics, detailed metrics) to create a full dataframe of predictors"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "740d97ee",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:29.745648Z",
     "iopub.status.busy": "2024-03-21T00:34:29.741652Z",
     "iopub.status.idle": "2024-03-21T00:34:29.860786Z",
     "shell.execute_reply": "2024-03-21T00:34:29.858733Z"
    },
    "papermill": {
     "duration": 0.138295,
     "end_time": "2024-03-21T00:34:29.863379",
     "exception": false,
     "start_time": "2024-03-21T00:34:29.725084",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Merge All DataFrames\n",
    "#Merge Metrics\n",
    "WMetrics <- merge(SimpleMetrics_W, DetailedMetrics_W, \n",
    "                 by = c(\"TeamID\", \"Season\", \"Games\"), all = TRUE)\n",
    "#Merge metrics and ELO\n",
    "WPredictors <- merge(WMetrics, FinalElo_W, by = c(\"TeamID\", \"Season\"), all.x = TRUE) %>% \n",
    "  select(-Games)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5634bd95",
   "metadata": {
    "papermill": {
     "duration": 0.014327,
     "end_time": "2024-03-21T00:34:29.892151",
     "exception": false,
     "start_time": "2024-03-21T00:34:29.877824",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## XGBoost\n",
    "### Set up dataframe for xgboost\n",
    "Merge NCAA tournament results with team data for each team"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "f0b30a68",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:29.927353Z",
     "iopub.status.busy": "2024-03-21T00:34:29.925595Z",
     "iopub.status.idle": "2024-03-21T00:34:30.243143Z",
     "shell.execute_reply": "2024-03-21T00:34:30.239783Z"
    },
    "papermill": {
     "duration": 0.337726,
     "end_time": "2024-03-21T00:34:30.246306",
     "exception": false,
     "start_time": "2024-03-21T00:34:29.908580",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Warning message in left_join(., WPredictors, by = c(Team1 = \"TeamID\", \"Season\")):\n",
      "“\u001b[1m\u001b[22mDetected an unexpected many-to-many relationship between `x` and `y`.\n",
      "\u001b[36mℹ\u001b[39m Row 2 of `x` matches multiple rows in `y`.\n",
      "\u001b[36mℹ\u001b[39m Row 323 of `y` matches multiple rows in `x`.\n",
      "\u001b[36mℹ\u001b[39m If a many-to-many relationship is expected, set `relationship =\n",
      "  \"many-to-many\"` to silence this warning.”\n",
      "Warning message in left_join(., WPredictors, by = c(Team2 = \"TeamID\", \"Season\")):\n",
      "“\u001b[1m\u001b[22mDetected an unexpected many-to-many relationship between `x` and `y`.\n",
      "\u001b[36mℹ\u001b[39m Row 4 of `x` matches multiple rows in `y`.\n",
      "\u001b[36mℹ\u001b[39m Row 4506 of `y` matches multiple rows in `x`.\n",
      "\u001b[36mℹ\u001b[39m If a many-to-many relationship is expected, set `relationship =\n",
      "  \"many-to-many\"` to silence this warning.”\n"
     ]
    }
   ],
   "source": [
    "#Load libraries\n",
    "library(dplyr) # for data cleaning\n",
    "library(xgboost) #For modelling\n",
    "\n",
    "WNCAATourneyCompactResults <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/WNCAATourneyCompactResults.csv\" , sep = ',')\n",
    "WNCAATourneyCompactResults <- WNCAATourneyCompactResults %>% filter(Season >= min(WDetailedResults$Season))\n",
    "WNCAATourneySeeds <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/WNCAATourneySeeds.csv\" , sep = ',')\n",
    "WNCAATourneySeeds <- WNCAATourneySeeds %>% filter(Season >= min(WDetailedResults$Season))\n",
    "WPredictors <- WPredictors\n",
    "\n",
    "\n",
    "#Set up df\n",
    "results <- WNCAATourneyCompactResults\n",
    "results$Team1 <- ifelse(results$WTeamID < results$LTeamID, results$WTeamID, results$LTeamID)\n",
    "results$Team2 <- ifelse(results$WTeamID > results$LTeamID, results$WTeamID, results$LTeamID)\n",
    "results <- results %>% \n",
    "  left_join(WPredictors, by = c(\"Team1\" = \"TeamID\", \"Season\")) %>% \n",
    "  rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, \n",
    "         T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, \n",
    "         T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, \n",
    "         T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,\n",
    "         T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, \n",
    "         T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, \n",
    "         T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, T1BlkStl = BlkStl, \n",
    "         T1TO = TO, T1AsstRat = AsstRat, T1OppReb = OppReb, T1OppORebRat = OppORebRat, \n",
    "         T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,\n",
    "         T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)\n",
    "results<- results %>% \n",
    "  left_join(WPredictors, by = c(\"Team2\" = \"TeamID\", \"Season\")) %>% \n",
    "  rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against,\n",
    "         T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, \n",
    "         T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, \n",
    "         T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,\n",
    "         T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, \n",
    "         T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, \n",
    "         T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, T2BlkStl = BlkStl, \n",
    "         T2TO = TO, T2AsstRat = AsstRat, T2OppReb = OppReb, T2OppORebRat = OppORebRat, \n",
    "         T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,\n",
    "         T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)\n",
    "results <- results %>%\n",
    "  left_join(WNCAATourneySeeds, by = c(\"Team1\" = \"TeamID\", \"Season\")) %>%\n",
    "  rename(Seed_T1 = Seed)\n",
    "results <- results %>%\n",
    "  left_join(WNCAATourneySeeds, by = c(\"Team2\" = \"TeamID\", \"Season\")) %>%\n",
    "  rename(Seed_T2 = Seed)\n",
    "results$SeedNum_T1 <- as.numeric(substr(results$Seed_T1,2,3))\n",
    "results$SeedNum_T2 <- as.numeric(substr(results$Seed_T2,2,3))\n",
    "results$Seed_len1 <- substr(results$Seed_T1,1,3)\n",
    "results$Seed_len2 <- substr(results$Seed_T2,1,3)\n",
    "\n",
    "results$result <- ifelse(results$WTeamID < results$LTeamID, 1, 0)\n",
    "results$Score1 <- ifelse(results$WTeamID < results$LTeamID, results$WScore, results$LScore)\n",
    "results$Score2 <- ifelse(results$WTeamID > results$LTeamID, results$WScore, results$LScore)\n",
    "results <- results %>%\n",
    "  mutate(ELO_diff = T1ELO-T2ELO,\n",
    "        Seed_diff = SeedNum_T1 - SeedNum_T2,\n",
    "        Win_pct_dif = T1Win_pct - T2Win_pct,\n",
    "        PTS_for = T1Pts_for - T2Pts_for,\n",
    "        PTS_against = T1Pts_against - T2Pts_against,\n",
    "        ThreePtShots_diff = T1ThreePtShots - T2ThreePtShots,\n",
    "        Reb_diff = T1Reb - T2Reb,\n",
    "        ORebRate_diff = T1ORebRat - T2ORebRat,\n",
    "        OppORebRate_diff = T1OppORebRat - T2OppORebRat,\n",
    "        rawSOS_diff = T1rawSOS - T2rawSOS,\n",
    "        ELOSOS_diff = T1ELOSOS - T2ELOSOS,\n",
    "        Rank_diff = T1Rank - T2Rank)\n",
    "results <- results[which(results$Seed_len1 != results$Seed_len2),]"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b93092a9",
   "metadata": {
    "papermill": {
     "duration": 0.014857,
     "end_time": "2024-03-21T00:34:30.276103",
     "exception": false,
     "start_time": "2024-03-21T00:34:30.261246",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Perform XGBoost"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "1edbf366",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:30.310476Z",
     "iopub.status.busy": "2024-03-21T00:34:30.308398Z",
     "iopub.status.idle": "2024-03-21T00:34:45.358513Z",
     "shell.execute_reply": "2024-03-21T00:34:45.356096Z"
    },
    "papermill": {
     "duration": 15.071738,
     "end_time": "2024-03-21T00:34:45.362341",
     "exception": false,
     "start_time": "2024-03-21T00:34:30.290603",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "set.seed(123)\n",
    "#Set Predictors\n",
    "predictors <- c(\"T1Win_pct\", \"T1Pts_for\", \"T1Pts_against\",\"T1Pts_diff\", \"T1LBlowouts\", \n",
    "                \"T1LClose\", \"T1rawSOS\", \"T1ELOSOS\", \"T1FgPct\", \"T1ThreePtPct\", \"T1ThreePtShots\",\n",
    "                \"T1FtPct\", \"T1FtA\", \"T1OppFgPct\", \"T1OppThreePtPct\", \"T1OppThreePtShots\", \n",
    "                \"T1OppFtA\", \"T1Wins\", \"T1Losses\", \"T1Reb\", \"T1OReb\", \"T1ORebRat\", \"T1BlkStl\",\n",
    "                \"T1TO\", \"T1AsstRat\", \"T1OppReb\", \"T1OppORebRat\", \n",
    "                \"T1OppBlkStl\", \"T1OppAsstRat\", \"T2OppBlkStl\", \"T2OppAsstRat\", \n",
    "                \"T1ELO\", \"T1Quad1Rec\", \"T1Quad1Games\", \"T2Win_pct\", \"T2Pts_for\", \n",
    "                \"T2Pts_against\", \"T2Pts_diff\", \"T2LBlowouts\", \"T2LClose\",\"T2rawSOS\", \n",
    "                \"T2ELOSOS\", \"T2FgPct\", \"T2ThreePtPct\", \"T2ThreePtShots\", \"T2FtPct\", \n",
    "                \"T2FtA\", \"T2OppFgPct\", \"T2OppThreePtPct\", \"T2OppThreePtShots\", \n",
    "                \"T2OppFtA\", \"T2Wins\", \"T2Losses\", \"T2Reb\", \"T2OReb\", \"T2ORebRat\", \"T2BlkStl\", \n",
    "                \"T2TO\", \"T2AsstRat\", \"T2OppReb\", \"T2OppORebRat\", \n",
    "                \"T2ELO\", \"T2Quad1Rec\", \"T2Quad1Games\", \"ELO_diff\", \n",
    "                \"T1Rank\", \"T2Rank\", \"Rank_diff\",\n",
    "                \"Seed_diff\", \"Win_pct_dif\", \"PTS_for\", \"PTS_against\", \n",
    "                \"ThreePtShots_diff\", \"Reb_diff\", \"ORebRate_diff\", \"OppORebRate_diff\", \n",
    "                \"rawSOS_diff\", \"ELOSOS_diff\")\n",
    "\n",
    "#Set features and label\n",
    "dtrain <- xgb.DMatrix(data = as.matrix(results[, predictors]), label = results$result)\n",
    "\n",
    "#Parameters\n",
    "params <- list(\n",
    "  objective = \"binary:logistic\",\n",
    "  booster = \"gbtree\",\n",
    "  eta = 0.01,\n",
    "  max_depth = 6,\n",
    "  subsample = 0.8,\n",
    "  colsample_bytree = 0.8\n",
    ")\n",
    "\n",
    "# Cross-validation\n",
    "cv_results <- xgb.cv(params = params,\n",
    "                     data = dtrain,\n",
    "                     nrounds = 1000,\n",
    "                     nfold = 5,\n",
    "                     metrics = \"logloss\",\n",
    "                     early_stopping_rounds = 10,\n",
    "                     maximize = FALSE,\n",
    "                     Prediction = TRUE,\n",
    "                     verbose = 0)\n",
    "# Extract the best number of rounds\n",
    "best_nrounds <- cv_results$best_iteration\n",
    "# Re-train the model on the full dataset using the best number of rounds\n",
    "Wfinal_model <- xgb.train(params = params,\n",
    "                         data = dtrain,\n",
    "                         nrounds = best_nrounds)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e29ff0e1",
   "metadata": {
    "papermill": {
     "duration": 0.015718,
     "end_time": "2024-03-21T00:34:45.394749",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.379031",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "### Print errors since 2018"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "9af32c48",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:45.428400Z",
     "iopub.status.busy": "2024-03-21T00:34:45.426471Z",
     "iopub.status.idle": "2024-03-21T00:34:45.576075Z",
     "shell.execute_reply": "2024-03-21T00:34:45.573621Z"
    },
    "papermill": {
     "duration": 0.169422,
     "end_time": "2024-03-21T00:34:45.578767",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.409345",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Season      error\n",
      "1   2018 0.03990937\n",
      "2   2019 0.03417942\n",
      "3   2021 0.03521979\n",
      "4   2022 0.04288960\n",
      "5   2023 0.04894401\n"
     ]
    }
   ],
   "source": [
    "ErrorTable <- data.frame(Season = numeric(), error = numeric())\n",
    "\n",
    "for (year in unique(results$Season)) {\n",
    "  data <- results[which(results$Season == year),]\n",
    "  dtest <- xgb.DMatrix(data = as.matrix(data[, predictors]))\n",
    "  predictions <- predict(Wfinal_model, dtest)\n",
    "  true_outcomes <- data$result\n",
    "  error <- mean((true_outcomes - predictions)^2)\n",
    "  year_error <- data.frame(Season = year, error = error)\n",
    "  ErrorTable <- rbind(ErrorTable, year_error)\n",
    "}\n",
    "\n",
    "ErrorTable <- ErrorTable %>% filter(Season >= 2018)\n",
    "print(ErrorTable)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c39c17a3",
   "metadata": {
    "papermill": {
     "duration": 0.015194,
     "end_time": "2024-03-21T00:34:45.608750",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.593556",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "### Calculate 2023 accuracy vs. simple model (based on seeds)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "e5d48d22",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:45.648183Z",
     "iopub.status.busy": "2024-03-21T00:34:45.644635Z",
     "iopub.status.idle": "2024-03-21T00:34:45.716618Z",
     "shell.execute_reply": "2024-03-21T00:34:45.713682Z"
    },
    "papermill": {
     "duration": 0.095149,
     "end_time": "2024-03-21T00:34:45.720571",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.625422",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[1] 1\n",
      "[1] 0.7301587\n"
     ]
    }
   ],
   "source": [
    "#True Acc vs Chalk Acc 2023\n",
    "data <- results[which(results$Season == 2023),]\n",
    "true_outcomes <- data$result\n",
    "dtest <- xgb.DMatrix(data = as.matrix(data[, predictors]))\n",
    "predictions <- predict(Wfinal_model, dtest)\n",
    "data$pred1 <- ifelse(predictions >= 0.5, 1, 0)\n",
    "predictions1 <- data$pred1\n",
    "TrueAcc <-mean(predictions1 == true_outcomes)\n",
    "print(TrueAcc)\n",
    "\n",
    "data$Chalk <- ifelse(data$SeedNum_T1 <= data$SeedNum_T2, \n",
    "                     1, 0)\n",
    "predictions2 <- data$Chalk\n",
    "ChalkAcc <- mean(predictions2 == true_outcomes)\n",
    "print(ChalkAcc)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ca2a367b",
   "metadata": {
    "papermill": {
     "duration": 0.015636,
     "end_time": "2024-03-21T00:34:45.751253",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.735617",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# CREATE BRACKET WOMENS\n",
    "## Set up bracket info\n",
    "Create round maps and initial round info"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "62e284c9",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:45.787810Z",
     "iopub.status.busy": "2024-03-21T00:34:45.785588Z",
     "iopub.status.idle": "2024-03-21T00:34:45.876613Z",
     "shell.execute_reply": "2024-03-21T00:34:45.873999Z"
    },
    "papermill": {
     "duration": 0.112765,
     "end_time": "2024-03-21T00:34:45.879852",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.767087",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Load libraries\n",
    "library(dplyr) # for data cleaning\n",
    "library(xgboost) #For modelling\n",
    "\n",
    "Seeds <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/2024_tourney_seeds.csv\" , sep = ',')\n",
    "WomensSeeds <- Seeds %>% \n",
    "  filter(Tournament == \"W\")\n",
    "Sub <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/sample_submission.csv\" , sep = ',')\n",
    "Slots <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/WNCAATourneySlots.csv\" , sep = ',')\n",
    "WTeams <- read.csv(\"/kaggle/input/march-machine-learning-mania-2024/WTeams.csv\" , sep = ',')\n",
    "WTeams <- WTeams %>% select(TeamID, TeamName)\n",
    "\n",
    "#General\n",
    "Predictors_2024 <- WPredictors %>% filter(Season == 2024)\n",
    "predictors <- c(\"T1Win_pct\", \"T1Pts_for\", \"T1Pts_against\",\"T1Pts_diff\", \"T1LBlowouts\", \n",
    "                \"T1LClose\", \"T1rawSOS\", \"T1ELOSOS\", \"T1FgPct\", \"T1ThreePtPct\", \"T1ThreePtShots\",\n",
    "                \"T1FtPct\", \"T1FtA\", \"T1OppFgPct\", \"T1OppThreePtPct\", \"T1OppThreePtShots\", \n",
    "                \"T1OppFtA\", \"T1Wins\", \"T1Losses\", \"T1Reb\", \"T1OReb\", \"T1ORebRat\", \"T1BlkStl\",\n",
    "                \"T1TO\", \"T1AsstRat\", \"T1OppReb\", \"T1OppORebRat\", \n",
    "                \"T1OppBlkStl\", \"T1OppAsstRat\", \"T2OppBlkStl\", \"T2OppAsstRat\", \n",
    "                \"T1ELO\", \"T1Quad1Rec\", \"T1Quad1Games\", \"T2Win_pct\", \"T2Pts_for\", \n",
    "                \"T2Pts_against\", \"T2Pts_diff\", \"T2LBlowouts\", \"T2LClose\",\"T2rawSOS\", \n",
    "                \"T2ELOSOS\", \"T2FgPct\", \"T2ThreePtPct\", \"T2ThreePtShots\", \"T2FtPct\", \n",
    "                \"T2FtA\", \"T2OppFgPct\", \"T2OppThreePtPct\", \"T2OppThreePtShots\", \n",
    "                \"T2OppFtA\", \"T2Wins\", \"T2Losses\", \"T2Reb\", \"T2OReb\", \"T2ORebRat\", \"T2BlkStl\", \n",
    "                \"T2TO\", \"T2AsstRat\", \"T2OppReb\", \"T2OppORebRat\", \n",
    "                \"T2ELO\", \"T2Quad1Rec\", \"T2Quad1Games\", \"ELO_diff\", \n",
    "                \"T1Rank\", \"T2Rank\", \"Rank_diff\",\n",
    "                \"Seed_diff\", \"Win_pct_dif\", \"PTS_for\", \"PTS_against\", \n",
    "                \"ThreePtShots_diff\", \"Reb_diff\", \"ORebRate_diff\", \"OppORebRate_diff\", \n",
    "                \"rawSOS_diff\", \"ELOSOS_diff\")\n",
    "\n",
    "#Seeding info\n",
    "initial_slots <- c(\n",
    "  'R1W1', 'R1W2', 'R1W3', 'R1W4', 'R1W5', 'R1W6', 'R1W7', 'R1W8',\n",
    "  'R1X1', 'R1X2', 'R1X3', 'R1X4', 'R1X5', 'R1X6', 'R1X7', 'R1X8',\n",
    "  'R1Y1', 'R1Y2', 'R1Y3', 'R1Y4', 'R1Y5', 'R1Y6', 'R1Y7', 'R1Y8',\n",
    "  'R1Z1', 'R1Z2', 'R1Z3', 'R1Z4', 'R1Z5', 'R1Z6', 'R1Z7', 'R1Z8'\n",
    ")\n",
    "\n",
    "initial_matchups <- list(\n",
    "  'R1W1' = c(\"01\", \"16\"),\n",
    "  'R1W2' = c(\"02\", \"15\"),\n",
    "  'R1W3' = c(\"03\", \"14\"),\n",
    "  'R1W4' = c(\"04\", \"13\"),\n",
    "  'R1W5' = c(\"05\", \"12\"),\n",
    "  'R1W6' = c(\"06\", \"11\"),\n",
    "  'R1W7' = c(\"07\", \"10\"),\n",
    "  'R1W8' = c(\"08\", \"09\"),\n",
    "  'R1X1' = c(\"01\", \"16\"),\n",
    "  'R1X2' = c(\"02\", \"15\"),\n",
    "  'R1X3' = c(\"03\", \"14\"),\n",
    "  'R1X4' = c(\"04\", \"13\"),\n",
    "  'R1X5' = c(\"05\", \"12\"),\n",
    "  'R1X6' = c(\"06\", \"11\"),\n",
    "  'R1X7' = c(\"07\", \"10\"),\n",
    "  'R1X8' = c(\"08\", \"09\"),\n",
    "  'R1Y1' = c(\"01\", \"16\"),\n",
    "  'R1Y2' = c(\"02\", \"15\"),\n",
    "  'R1Y3' = c(\"03\", \"14\"),\n",
    "  'R1Y4' = c(\"04\", \"13\"),\n",
    "  'R1Y5' = c(\"05\", \"12\"),\n",
    "  'R1Y6' = c(\"06\", \"11\"),\n",
    "  'R1Y7' = c(\"07\", \"10\"),\n",
    "  'R1Y8' = c(\"08\", \"09\"),\n",
    "  'R1Z1' = c(\"01\", \"16\"),\n",
    "  'R1Z2' = c(\"02\", \"15\"),\n",
    "  'R1Z3' = c(\"03\", \"14\"),\n",
    "  'R1Z4' = c(\"04\", \"13\"),\n",
    "  'R1Z5' = c(\"05\", \"12\"),\n",
    "  'R1Z6' = c(\"06\", \"11\"),\n",
    "  'R1Z7' = c(\"07\", \"10\"),\n",
    "  'R1Z8' = c(\"08\", \"09\")\n",
    ")\n",
    "\n",
    "\n",
    "round2_map <- list(\n",
    "  'R1W1' = 'R2W1', 'R1W8' = 'R2W1',\n",
    "  'R1W2' = 'R2W2', 'R1W7' = 'R2W2',\n",
    "  'R1W3' = 'R2W3', 'R1W6' = 'R2W3',\n",
    "  'R1W4' = 'R2W4', 'R1W5' = 'R2W4',\n",
    "  'R1X1' = 'R2X1', 'R1X8' = 'R2X1',\n",
    "  'R1X2' = 'R2X2', 'R1X7' = 'R2X2',\n",
    "  'R1X3' = 'R2X3', 'R1X6' = 'R2X3',\n",
    "  'R1X4' = 'R2X4', 'R1X5' = 'R2X4',\n",
    "  'R1Y1' = 'R2Y1', 'R1Y8' = 'R2Y1',\n",
    "  'R1Y2' = 'R2Y2', 'R1Y7' = 'R2Y2',\n",
    "  'R1Y3' = 'R2Y3', 'R1Y6' = 'R2Y3',\n",
    "  'R1Y4' = 'R2Y4', 'R1Y5' = 'R2Y4',\n",
    "  'R1Z1' = 'R2Z1', 'R1Z8' = 'R2Z1',\n",
    "  'R1Z2' = 'R2Z2', 'R1Z7' = 'R2Z2',\n",
    "  'R1Z3' = 'R2Z3', 'R1Z6' = 'R2Z3',\n",
    "  'R1Z4' = 'R2Z4', 'R1Z5' = 'R2Z4'\n",
    ")\n",
    "\n",
    "round3_map <- list(\n",
    "  'R2W1' = 'R3W1', 'R2W4' = 'R3W1',\n",
    "  'R2W2' = 'R3W2', 'R2W3' = 'R3W2',\n",
    "  'R2X1' = 'R3X1', 'R2X4' = 'R3X1',\n",
    "  'R2X2' = 'R3X2', 'R2X3' = 'R3X2',\n",
    "  'R2Y1' = 'R3Y1', 'R2Y4' = 'R3Y1',\n",
    "  'R2Y2' = 'R3Y2', 'R2Y3' = 'R3Y2',\n",
    "  'R2Z1' = 'R3Z1', 'R2Z4' = 'R3Z1',\n",
    "  'R2Z2' = 'R3Z2', 'R2Z3' = 'R3Z2'\n",
    ")\n",
    "\n",
    "round4_map <- list(\n",
    "  'R3W1' = 'R4W1', 'R3W2' = 'R4W1',\n",
    "  'R3X1' = 'R4X1', 'R3X2' = 'R4X1',\n",
    "  'R3Y1' = 'R4Y1', 'R3Y2' = 'R4Y1',\n",
    "  'R3Z1' = 'R4Z1', 'R3Z2' = 'R4Z1'\n",
    ")\n",
    "\n",
    "round5_map <- list(\n",
    "  'R4W1' = 'R5WX', 'R4X1' = 'R5WX',\n",
    "  'R4Y1' = 'R5YZ', 'R4Z1' = 'R5YZ'\n",
    ")\n",
    "\n",
    "round6_map <- list(\n",
    "  'R5WX' = 'R6CH',\n",
    "  'R5YZ' = 'R6CH'\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d247d829",
   "metadata": {
    "papermill": {
     "duration": 0.016209,
     "end_time": "2024-03-21T00:34:45.911683",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.895474",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Round 1 predictions"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "33d956b6",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:45.947249Z",
     "iopub.status.busy": "2024-03-21T00:34:45.945405Z",
     "iopub.status.idle": "2024-03-21T00:34:46.214917Z",
     "shell.execute_reply": "2024-03-21T00:34:46.212567Z"
    },
    "papermill": {
     "duration": 0.290913,
     "end_time": "2024-03-21T00:34:46.218618",
     "exception": false,
     "start_time": "2024-03-21T00:34:45.927705",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Round 1 Predictions\n",
    "Rd1Df <- data.frame(Slot = character(), Team1 = character(), Team2 = character(), \n",
    "                    SeedNum_T1 = numeric(), SeedNum_T2 = numeric())\n",
    "for (key in names(initial_matchups)) {\n",
    "  slot <- substr(key, 3, 3)\n",
    "  teams <- initial_matchups[[key]]\n",
    "  SeedNum_T1 <- as.numeric(teams[1])\n",
    "  SeedNum_T2 <- as.numeric(teams[2])\n",
    "  team1 <- paste0(slot, teams[1])\n",
    "  team2 <- paste0(slot, teams[2])\n",
    "  row_df <- data.frame(Slot = key, Team1 = team1, Team2 = team2, \n",
    "                       SeedNum_T1 = SeedNum_T1,  SeedNum_T2 =  SeedNum_T2)\n",
    "  Rd1Df <- rbind(Rd1Df, row_df)\n",
    "}\n",
    "Rd1Df$Tournament = \"W\"\n",
    "\n",
    "Rd1_team1 <- Rd1Df %>% \n",
    "  left_join(WomensSeeds, by = c(\"Tournament\", \"Team1\" = \"Seed\")) %>% \n",
    "  rename(Team1ID = TeamID)\n",
    "Rd1_team2 <- Rd1Df %>% \n",
    "  left_join(WomensSeeds, by = c(\"Tournament\", \"Team2\" = \"Seed\")) %>% \n",
    "  rename(Team2ID = TeamID)\n",
    "\n",
    "Rd1_pred <- merge(Rd1_team1, Rd1_team2, \n",
    "                  by = c(\"Tournament\", \"Slot\", \"Team1\", \"Team2\",  \n",
    "                         \"SeedNum_T1\",  \"SeedNum_T2\"), all = TRUE)\n",
    "Rd1_data <- Rd1_pred %>% \n",
    "  left_join(Predictors_2024, by = c(\"Team1ID\" = \"TeamID\")) %>% \n",
    "  rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, \n",
    "         T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, \n",
    "         T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, \n",
    "         T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,\n",
    "         T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, \n",
    "         T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, \n",
    "         T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, T1BlkStl = BlkStl, \n",
    "         T1TO = TO, T1AsstRat = AsstRat, T1OppReb = OppReb, T1OppORebRat = OppORebRat, \n",
    "         T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,\n",
    "         T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)\n",
    "Rd1_data <- Rd1_data %>% \n",
    "  left_join(Predictors_2024, by = c(\"Team2ID\" = \"TeamID\")) %>% \n",
    "  rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against, \n",
    "         T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, \n",
    "         T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, \n",
    "         T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,\n",
    "         T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, \n",
    "         T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, \n",
    "         T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, T2BlkStl = BlkStl, \n",
    "         T2TO = TO, T2AsstRat = AsstRat, T2OppReb = OppReb, T2OppORebRat = OppORebRat, \n",
    "         T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,\n",
    "         T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)\n",
    "Rd1_data$ELO_diff <- Rd1_data$T1ELO - Rd1_data$T2ELO\n",
    "Rd1_data$Seed_diff <- Rd1_data$SeedNum_T1 - Rd1_data$SeedNum_T2\n",
    "Rd1_data$Win_pct_dif <- Rd1_data$T1Win_pct - Rd1_data$T2Win_pct\n",
    "Rd1_data$PTS_for <- Rd1_data$T1Pts_for - Rd1_data$T2Pts_for\n",
    "Rd1_data$PTS_against <- Rd1_data$T1Pts_against - Rd1_data$T2Pts_against\n",
    "Rd1_data$ThreePtShots_diff <- Rd1_data$T1ThreePtShots - Rd1_data$T2ThreePtShots\n",
    "Rd1_data$Reb_diff <- Rd1_data$T1Reb - Rd1_data$T2Reb\n",
    "Rd1_data$ORebRate_diff <- Rd1_data$T1ORebRat - Rd1_data$T2ORebRat\n",
    "Rd1_data$OppORebRate_diff <- Rd1_data$T1OppORebRat - Rd1_data$T2OppORebRat\n",
    "Rd1_data$rawSOS_diff <- Rd1_data$T1rawSOS - Rd1_data$T2rawSOS\n",
    "Rd1_data$ELOSOS_diff <- Rd1_data$T1ELOSOS - Rd1_data$T2ELOSOS\n",
    "Rd1_data$Rank_diff <- Rd1_data$T1Rank - Rd1_data$T2Rank\n",
    "rd_1_dmatrix <- xgb.DMatrix(data = as.matrix(Rd1_data[, predictors]))\n",
    "predictions <- predict(Wfinal_model, newdata = rd_1_dmatrix)\n",
    "Rd1_pred$Team <- ifelse(predictions >= 0.5, Rd1_pred$Team1ID, Rd1_pred$Team2ID)\n",
    "Rd1_pred$Win <- ifelse(Rd1_pred$Team == Rd1_pred$Team1ID, Rd1_pred$Team1, Rd1_pred$Team2)\n",
    "Rd1_pred$Seed <- ifelse(Rd1_pred$Team == Rd1_pred$Team1ID, \n",
    "                        Rd1_pred$SeedNum_T1, Rd1_pred$SeedNum_T2)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c54e6006",
   "metadata": {
    "papermill": {
     "duration": 0.015964,
     "end_time": "2024-03-21T00:34:46.251007",
     "exception": false,
     "start_time": "2024-03-21T00:34:46.235043",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Function for repeating for the following rounds"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "73b2642f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:46.287427Z",
     "iopub.status.busy": "2024-03-21T00:34:46.285460Z",
     "iopub.status.idle": "2024-03-21T00:34:46.313231Z",
     "shell.execute_reply": "2024-03-21T00:34:46.309952Z"
    },
    "papermill": {
     "duration": 0.049986,
     "end_time": "2024-03-21T00:34:46.316273",
     "exception": false,
     "start_time": "2024-03-21T00:34:46.266287",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Define round by round function\n",
    "Rd_by_rd <- function(rd1, map, Predictors_2024, features) {\n",
    "  unique_destinations <- unique(unlist(map))\n",
    "  new_pred <- data.frame(Tournament = \"W\",\n",
    "                         Slot = unique_destinations,\n",
    "                         Team1 = character(length(unique_destinations)),\n",
    "                         Team2 = character(length(unique_destinations)),\n",
    "                         Team1ID = integer(length(unique_destinations)),\n",
    "                         Team2ID = integer(length(unique_destinations)),\n",
    "                         SeedNum_T1 = numeric(length(unique_destinations)),\n",
    "                         SeedNum_T2 = numeric(length(unique_destinations)))\n",
    "  for (i in 1:nrow(rd1)) {\n",
    "    Slot <- rd1$Slot[i]\n",
    "    Dest <- map[[Slot]]\n",
    "    row_index <- which(new_pred$Slot == Dest)\n",
    "    if (nchar(as.character(new_pred[row_index, \"Team1\"])) != 3) {\n",
    "      # Data corresponds to Team1\n",
    "      new_pred[row_index, \"Team1\"] <- rd1$Win[i]\n",
    "      new_pred[row_index, \"Team1ID\"] <- rd1$Team[i]\n",
    "      new_pred[row_index, \"SeedNum_T1\"] <- rd1$Seed[i]\n",
    "    } else {\n",
    "      # Data corresponds to Team2\n",
    "      new_pred[row_index, \"Team2\"] <- rd1$Win[i]\n",
    "      new_pred[row_index, \"Team2ID\"] <- rd1$Team[i]\n",
    "      new_pred[row_index, \"SeedNum_T2\"] <- rd1$Seed[i]\n",
    "    }\n",
    "  }\n",
    "  #Add features\n",
    "  Rd1_data <- new_pred %>% \n",
    "    left_join(Predictors_2024, by = c(\"Team1ID\" = \"TeamID\")) %>% \n",
    "    rename(T1Win_pct = Win_pct, T1Pts_for = Pts_for, T1Pts_against = Pts_against, \n",
    "           T1Pts_diff = Pts_diff, T1LBlowouts = LBlowouts, T1LClose = LClose, \n",
    "           T1rawSOS = rawSOS, T1ELOSOS = ELOSOS, T1FgPct = FgPct, T1ThreePtPct = ThreePtPct, \n",
    "           T1ThreePtShots = ThreePtShots, T1FtPct = FtPct, T1FtA = FtA,\n",
    "           T1OppFgPct = OppFgPct, T1OppThreePtPct = OppThreePtPct, \n",
    "           T1OppThreePtShots = OppThreePtShots, T1OppFtA = OppFtA, T1Wins = Wins, \n",
    "           T1Losses = Losses, T1Reb = Reb, T1OReb = OReb, T1ORebRat = ORebRat, \n",
    "           T1BlkStl = BlkStl, \n",
    "           T1TO = TO, T1AsstRat = AsstRat, T1OppReb = OppReb, T1OppORebRat = OppORebRat, \n",
    "           T1OppBlkStl = OppBlkStl, T1OppAsstRat = OppAsstRat, T1ELO = ELO,\n",
    "           T1Quad1Rec = Quad1Rec, T1Quad1Games = Quad1Games, T1Rank = Rank)\n",
    "  Rd1_data <- Rd1_data %>% \n",
    "    left_join(Predictors_2024, by = c(\"Team2ID\" = \"TeamID\")) %>% \n",
    "    rename(T2Win_pct = Win_pct, T2Pts_for = Pts_for, T2Pts_against = Pts_against,\n",
    "           T2Pts_diff = Pts_diff, T2LBlowouts = LBlowouts, T2LClose = LClose, \n",
    "           T2rawSOS = rawSOS, T2ELOSOS = ELOSOS, T2FgPct = FgPct, T2ThreePtPct = ThreePtPct, \n",
    "           T2ThreePtShots = ThreePtShots, T2FtPct = FtPct, T2FtA = FtA,\n",
    "           T2OppFgPct = OppFgPct, T2OppThreePtPct = OppThreePtPct, \n",
    "           T2OppThreePtShots = OppThreePtShots, T2OppFtA = OppFtA, T2Wins = Wins, \n",
    "           T2Losses = Losses, T2Reb = Reb, T2OReb = OReb, T2ORebRat = ORebRat, \n",
    "           T2BlkStl = BlkStl, \n",
    "           T2TO = TO, T2AsstRat = AsstRat, T2OppReb = OppReb, T2OppORebRat = OppORebRat, \n",
    "           T2OppBlkStl = OppBlkStl, T2OppAsstRat = OppAsstRat, T2ELO = ELO,\n",
    "           T2Quad1Rec = Quad1Rec, T2Quad1Games = Quad1Games, T2Rank = Rank)\n",
    "  Rd1_data$ELO_diff <- Rd1_data$T1ELO - Rd1_data$T2ELO\n",
    "  Rd1_data$Seed_diff <- Rd1_data$SeedNum_T1 - Rd1_data$SeedNum_T2\n",
    "  Rd1_data$Win_pct_dif <- Rd1_data$T1Win_pct - Rd1_data$T2Win_pct\n",
    "  Rd1_data$PTS_for <- Rd1_data$T1Pts_for - Rd1_data$T2Pts_for\n",
    "  Rd1_data$PTS_against <- Rd1_data$T1Pts_against - Rd1_data$T2Pts_against\n",
    "  Rd1_data$ThreePtShots_diff <- Rd1_data$T1ThreePtShots - Rd1_data$T2ThreePtShots\n",
    "  Rd1_data$Reb_diff <- Rd1_data$T1Reb - Rd1_data$T2Reb\n",
    "  Rd1_data$ORebRate_diff <- Rd1_data$T1ORebRat - Rd1_data$T2ORebRat\n",
    "  Rd1_data$OppORebRate_diff <- Rd1_data$T1OppORebRat - Rd1_data$T2OppORebRat\n",
    "  Rd1_data$rawSOS_diff <- Rd1_data$T1rawSOS - Rd1_data$T2rawSOS\n",
    "  Rd1_data$ELOSOS_diff <- Rd1_data$T1ELOSOS - Rd1_data$T2ELOSOS\n",
    "  Rd1_data$Rank_diff <- Rd1_data$T1Rank - Rd1_data$T2Rank\n",
    "  #Predictions\n",
    "  rd_1_dmatrix <- xgb.DMatrix(data = as.matrix(Rd1_data[, features]))\n",
    "  predictions <- predict(Wfinal_model, newdata = rd_1_dmatrix)\n",
    "  new_pred$Team <- ifelse(predictions >= 0.5, new_pred$Team1ID, new_pred$Team2ID)\n",
    "  new_pred$Win <- ifelse(new_pred$Team == new_pred$Team1ID, new_pred$Team1, new_pred$Team2)\n",
    "  new_pred$Seed <- ifelse(new_pred$Team == new_pred$Team1ID, \n",
    "                          new_pred$SeedNum_T1, new_pred$SeedNum_T2)\n",
    "  return(new_pred)\n",
    "}"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a54a5e0f",
   "metadata": {
    "papermill": {
     "duration": 0.016398,
     "end_time": "2024-03-21T00:34:46.348019",
     "exception": false,
     "start_time": "2024-03-21T00:34:46.331621",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Create bracket"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "68bf528e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:46.384960Z",
     "iopub.status.busy": "2024-03-21T00:34:46.383047Z",
     "iopub.status.idle": "2024-03-21T00:34:47.025606Z",
     "shell.execute_reply": "2024-03-21T00:34:47.023187Z"
    },
    "papermill": {
     "duration": 0.665149,
     "end_time": "2024-03-21T00:34:47.029932",
     "exception": false,
     "start_time": "2024-03-21T00:34:46.364783",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "#Rest of rounds\n",
    "Rd2_pred <- Rd_by_rd(Rd1_pred, round2_map, Predictors_2024, predictors)\n",
    "Rd3_pred <- Rd_by_rd(Rd2_pred, round3_map, Predictors_2024, predictors)\n",
    "Rd4_pred <- Rd_by_rd(Rd3_pred, round4_map, Predictors_2024, predictors)\n",
    "Rd5_pred <- Rd_by_rd(Rd4_pred, round5_map, Predictors_2024, predictors)\n",
    "Rd6_pred <- Rd_by_rd(Rd5_pred, round6_map, Predictors_2024, predictors)\n",
    "\n",
    "#Combine all data\n",
    "Rd12_pred <- rbind(Rd1_pred, Rd2_pred)\n",
    "Rd123_pred <- rbind(Rd12_pred, Rd3_pred)\n",
    "Rd1234_pred <- rbind(Rd123_pred, Rd4_pred)\n",
    "Rd12345_pred <- rbind(Rd1234_pred, Rd5_pred)\n",
    "WAll_pred <- rbind(Rd12345_pred, Rd6_pred) \n",
    "WAll_pred <- WAll_pred %>% left_join(WTeams, by = c(\"Team\" = \"TeamID\"))\n",
    "\n",
    "WFinal_names <- WAll_pred %>%  \n",
    "  select(Tournament, Slot, Team = Win, TeamName)\n",
    "\n",
    "WFinalBracket <- WAll_pred %>%  \n",
    "  mutate(Bracket = 1) %>% \n",
    "  select(Tournament, Bracket, Slot, Team = Win)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b7a11134",
   "metadata": {
    "papermill": {
     "duration": 0.01558,
     "end_time": "2024-03-21T00:34:47.060995",
     "exception": false,
     "start_time": "2024-03-21T00:34:47.045415",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "## Print final bracket with names"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "4889888d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:47.097480Z",
     "iopub.status.busy": "2024-03-21T00:34:47.095499Z",
     "iopub.status.idle": "2024-03-21T00:34:47.123678Z",
     "shell.execute_reply": "2024-03-21T00:34:47.120631Z"
    },
    "papermill": {
     "duration": 0.050322,
     "end_time": "2024-03-21T00:34:47.126722",
     "exception": false,
     "start_time": "2024-03-21T00:34:47.076400",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "   Tournament Slot Team       TeamName\n",
      "1           W R1W1  W01 South Carolina\n",
      "2           W R1W2  W02     Notre Dame\n",
      "3           W R1W3  W03      Oregon St\n",
      "4           W R1W4  W04        Indiana\n",
      "5           W R1W5  W05       Oklahoma\n",
      "6           W R1W6  W06       Nebraska\n",
      "7           W R1W7  W10      Marquette\n",
      "8           W R1W8  W08 North Carolina\n",
      "9           W R1X1  X01          Texas\n",
      "10          W R1X2  X02       Stanford\n",
      "11          W R1X3  X03       NC State\n",
      "12          W R1X4  X04        Gonzaga\n",
      "13          W R1X5  X05           Utah\n",
      "14          W R1X6  X06      Tennessee\n",
      "15          W R1X7  X07        Iowa St\n",
      "16          W R1X8  X09     Florida St\n",
      "17          W R1Y1  Y01           Iowa\n",
      "18          W R1Y2  Y02           UCLA\n",
      "19          W R1Y3  Y03            LSU\n",
      "20          W R1Y4  Y04      Kansas St\n",
      "21          W R1Y5  Y05       Colorado\n",
      "22          W R1Y6  Y06     Louisville\n",
      "23          W R1Y7  Y07      Creighton\n",
      "24          W R1Y8  Y08  West Virginia\n",
      "25          W R1Z1  Z01            USC\n",
      "26          W R1Z2  Z02        Ohio St\n",
      "27          W R1Z3  Z03    Connecticut\n",
      "28          W R1Z4  Z04  Virginia Tech\n",
      "29          W R1Z5  Z05         Baylor\n",
      "30          W R1Z6  Z11        Arizona\n",
      "31          W R1Z7  Z07           Duke\n",
      "32          W R1Z8  Z08         Kansas\n",
      "33          W R2W1  W01 South Carolina\n",
      "34          W R2W2  W02     Notre Dame\n",
      "35          W R2W3  W06       Nebraska\n",
      "36          W R2W4  W04        Indiana\n",
      "37          W R2X1  X01          Texas\n",
      "38          W R2X2  X02       Stanford\n",
      "39          W R2X3  X06      Tennessee\n",
      "40          W R2X4  X04        Gonzaga\n",
      "41          W R2Y1  Y01           Iowa\n",
      "42          W R2Y2  Y02           UCLA\n",
      "43          W R2Y3  Y03            LSU\n",
      "44          W R2Y4  Y04      Kansas St\n",
      "45          W R2Z1  Z01            USC\n",
      "46          W R2Z2  Z07           Duke\n",
      "47          W R2Z3  Z03    Connecticut\n",
      "48          W R2Z4  Z04  Virginia Tech\n",
      "49          W R3W1  W01 South Carolina\n",
      "50          W R3W2  W02     Notre Dame\n",
      "51          W R3X1  X01          Texas\n",
      "52          W R3X2  X02       Stanford\n",
      "53          W R3Y1  Y01           Iowa\n",
      "54          W R3Y2  Y03            LSU\n",
      "55          W R3Z1  Z01            USC\n",
      "56          W R3Z2  Z03    Connecticut\n",
      "57          W R4W1  W01 South Carolina\n",
      "58          W R4X1  X01          Texas\n",
      "59          W R4Y1  Y03            LSU\n",
      "60          W R4Z1  Z03    Connecticut\n",
      "61          W R5WX  W01 South Carolina\n",
      "62          W R5YZ  Z03    Connecticut\n",
      "63          W R6CH  W01 South Carolina\n"
     ]
    }
   ],
   "source": [
    "print(WFinal_names)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b6be2374",
   "metadata": {
    "papermill": {
     "duration": 0.016962,
     "end_time": "2024-03-21T00:34:47.160765",
     "exception": false,
     "start_time": "2024-03-21T00:34:47.143803",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# COMBINE FOR SUBMISSION"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "3dd97324",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:47.198667Z",
     "iopub.status.busy": "2024-03-21T00:34:47.196535Z",
     "iopub.status.idle": "2024-03-21T00:34:47.245167Z",
     "shell.execute_reply": "2024-03-21T00:34:47.241140Z"
    },
    "papermill": {
     "duration": 0.071258,
     "end_time": "2024-03-21T00:34:47.248176",
     "exception": false,
     "start_time": "2024-03-21T00:34:47.176918",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "    RowId Tournament Bracket Slot Team\n",
      "1       0          M       1 R1W1  W01\n",
      "2       1          M       1 R1W2  W02\n",
      "3       2          M       1 R1W3  W03\n",
      "4       3          M       1 R1W4  W04\n",
      "5       4          M       1 R1W5  W05\n",
      "6       5          M       1 R1W6  W11\n",
      "7       6          M       1 R1W7  W10\n",
      "8       7          M       1 R1W8  W08\n",
      "9       8          M       1 R1X1  X01\n",
      "10      9          M       1 R1X2  X02\n",
      "11     10          M       1 R1X3  X03\n",
      "12     11          M       1 R1X4  X04\n",
      "13     12          M       1 R1X5  X05\n",
      "14     13          M       1 R1X6  X11\n",
      "15     14          M       1 R1X7  X10\n",
      "16     15          M       1 R1X8  X08\n",
      "17     16          M       1 R1Y1  Y01\n",
      "18     17          M       1 R1Y2  Y02\n",
      "19     18          M       1 R1Y3  Y03\n",
      "20     19          M       1 R1Y4  Y04\n",
      "21     20          M       1 R1Y5  Y05\n",
      "22     21          M       1 R1Y6  Y06\n",
      "23     22          M       1 R1Y7  Y10\n",
      "24     23          M       1 R1Y8  Y09\n",
      "25     24          M       1 R1Z1  Z01\n",
      "26     25          M       1 R1Z2  Z02\n",
      "27     26          M       1 R1Z3  Z03\n",
      "28     27          M       1 R1Z4  Z04\n",
      "29     28          M       1 R1Z5  Z05\n",
      "30     29          M       1 R1Z6  Z06\n",
      "31     30          M       1 R1Z7  Z10\n",
      "32     31          M       1 R1Z8  Z09\n",
      "33     32          M       1 R2W1  W01\n",
      "34     33          M       1 R2W2  W02\n",
      "35     34          M       1 R2W3  W03\n",
      "36     35          M       1 R2W4  W04\n",
      "37     36          M       1 R2X1  X01\n",
      "38     37          M       1 R2X2  X02\n",
      "39     38          M       1 R2X3  X11\n",
      "40     39          M       1 R2X4  X05\n",
      "41     40          M       1 R2Y1  Y01\n",
      "42     41          M       1 R2Y2  Y02\n",
      "43     42          M       1 R2Y3  Y06\n",
      "44     43          M       1 R2Y4  Y05\n",
      "45     44          M       1 R2Z1  Z01\n",
      "46     45          M       1 R2Z2  Z10\n",
      "47     46          M       1 R2Z3  Z06\n",
      "48     47          M       1 R2Z4  Z05\n",
      "49     48          M       1 R3W1  W01\n",
      "50     49          M       1 R3W2  W02\n",
      "51     50          M       1 R3X1  X01\n",
      "52     51          M       1 R3X2  X02\n",
      "53     52          M       1 R3Y1  Y01\n",
      "54     53          M       1 R3Y2  Y02\n",
      "55     54          M       1 R3Z1  Z01\n",
      "56     55          M       1 R3Z2  Z06\n",
      "57     56          M       1 R4W1  W01\n",
      "58     57          M       1 R4X1  X02\n",
      "59     58          M       1 R4Y1  Y01\n",
      "60     59          M       1 R4Z1  Z01\n",
      "61     60          M       1 R5WX  W01\n",
      "62     61          M       1 R5YZ  Y01\n",
      "63     62          M       1 R6CH  Y01\n",
      "64     63          W       1 R1W1  W01\n",
      "65     64          W       1 R1W2  W02\n",
      "66     65          W       1 R1W3  W03\n",
      "67     66          W       1 R1W4  W04\n",
      "68     67          W       1 R1W5  W05\n",
      "69     68          W       1 R1W6  W06\n",
      "70     69          W       1 R1W7  W10\n",
      "71     70          W       1 R1W8  W08\n",
      "72     71          W       1 R1X1  X01\n",
      "73     72          W       1 R1X2  X02\n",
      "74     73          W       1 R1X3  X03\n",
      "75     74          W       1 R1X4  X04\n",
      "76     75          W       1 R1X5  X05\n",
      "77     76          W       1 R1X6  X06\n",
      "78     77          W       1 R1X7  X07\n",
      "79     78          W       1 R1X8  X09\n",
      "80     79          W       1 R1Y1  Y01\n",
      "81     80          W       1 R1Y2  Y02\n",
      "82     81          W       1 R1Y3  Y03\n",
      "83     82          W       1 R1Y4  Y04\n",
      "84     83          W       1 R1Y5  Y05\n",
      "85     84          W       1 R1Y6  Y06\n",
      "86     85          W       1 R1Y7  Y07\n",
      "87     86          W       1 R1Y8  Y08\n",
      "88     87          W       1 R1Z1  Z01\n",
      "89     88          W       1 R1Z2  Z02\n",
      "90     89          W       1 R1Z3  Z03\n",
      "91     90          W       1 R1Z4  Z04\n",
      "92     91          W       1 R1Z5  Z05\n",
      "93     92          W       1 R1Z6  Z11\n",
      "94     93          W       1 R1Z7  Z07\n",
      "95     94          W       1 R1Z8  Z08\n",
      "96     95          W       1 R2W1  W01\n",
      "97     96          W       1 R2W2  W02\n",
      "98     97          W       1 R2W3  W06\n",
      "99     98          W       1 R2W4  W04\n",
      "100    99          W       1 R2X1  X01\n",
      "101   100          W       1 R2X2  X02\n",
      "102   101          W       1 R2X3  X06\n",
      "103   102          W       1 R2X4  X04\n",
      "104   103          W       1 R2Y1  Y01\n",
      "105   104          W       1 R2Y2  Y02\n",
      "106   105          W       1 R2Y3  Y03\n",
      "107   106          W       1 R2Y4  Y04\n",
      "108   107          W       1 R2Z1  Z01\n",
      "109   108          W       1 R2Z2  Z07\n",
      "110   109          W       1 R2Z3  Z03\n",
      "111   110          W       1 R2Z4  Z04\n",
      "112   111          W       1 R3W1  W01\n",
      "113   112          W       1 R3W2  W02\n",
      "114   113          W       1 R3X1  X01\n",
      "115   114          W       1 R3X2  X02\n",
      "116   115          W       1 R3Y1  Y01\n",
      "117   116          W       1 R3Y2  Y03\n",
      "118   117          W       1 R3Z1  Z01\n",
      "119   118          W       1 R3Z2  Z03\n",
      "120   119          W       1 R4W1  W01\n",
      "121   120          W       1 R4X1  X01\n",
      "122   121          W       1 R4Y1  Y03\n",
      "123   122          W       1 R4Z1  Z03\n",
      "124   123          W       1 R5WX  W01\n",
      "125   124          W       1 R5YZ  Z03\n",
      "126   125          W       1 R6CH  W01\n"
     ]
    }
   ],
   "source": [
    "FinalBracket <- rbind(MFinalBracket, WFinalBracket)\n",
    "FinalBracket$RowId <- seq(0, nrow(FinalBracket) - 1)\n",
    "FinalBracket <- FinalBracket %>% select(RowId, Tournament, Bracket, Slot, Team)\n",
    "print(FinalBracket)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "f3fcb39e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2024-03-21T00:34:47.285145Z",
     "iopub.status.busy": "2024-03-21T00:34:47.283254Z",
     "iopub.status.idle": "2024-03-21T00:34:47.306168Z",
     "shell.execute_reply": "2024-03-21T00:34:47.303070Z"
    },
    "papermill": {
     "duration": 0.044964,
     "end_time": "2024-03-21T00:34:47.309232",
     "exception": false,
     "start_time": "2024-03-21T00:34:47.264268",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "write.csv(FinalBracket,\"submission.csv\", row.names = FALSE)"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "none",
   "dataSources": [
    {
     "databundleVersionId": 7985011,
     "sourceId": 70068,
     "sourceType": "competition"
    }
   ],
   "dockerImageVersionId": 30618,
   "isGpuEnabled": false,
   "isInternetEnabled": false,
   "language": "r",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "R",
   "language": "R",
   "name": "ir"
  },
  "language_info": {
   "codemirror_mode": "r",
   "file_extension": ".r",
   "mimetype": "text/x-r-source",
   "name": "R",
   "pygments_lexer": "r",
   "version": "4.0.5"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 1086.306648,
   "end_time": "2024-03-21T00:34:47.449762",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2024-03-21T00:16:41.143114",
   "version": "2.5.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
